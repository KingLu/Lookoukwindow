---
description: Git 提交规范和最佳实践
alwaysApply: true
---

# Git 提交规范

## 语言规范

**本项目强制要求使用中文。**

1. **提交信息（Commit Message）**：无论是主题（Subject）还是正文（Body），都**必须使用中文**撰写。
2. **代码注释（Code Comments）**：代码中的注释也**必须使用中文**撰写，以便于团队维护。

## 提交信息格式

提交信息必须遵循以下格式：

```
<类型>(<范围>): <主题>

<正文>

<脚注>
```    
**注意：请务必使用中文撰写提交信息！**

### 类型（Type）

提交类型必须使用以下之一：

- **feat**: 新功能
- **fix**: 修复 bug
- **docs**: 文档变更
- **style**: 代码格式调整（不影响代码运行）
- **refactor**: 代码重构（既不是新功能也不是修复 bug）
- **perf**: 性能优化
- **test**: 添加或修改测试
- **chore**: 构建过程或辅助工具的变动
- **ci**: CI/CD 相关变更
- **config**: 配置文件变更

### 范围（Scope）

可选，表示影响的范围，例如：

- `api`: API 相关
- `auth`: 认证相关
- `config`: 配置相关
- `google_photos`: Google 相册功能
- `youtube`: YouTube 功能
- `ui`: 用户界面
- `security`: 安全相关
- `cache`: 缓存相关

### 主题（Subject）

- 使用中文描述
- 简短明了，不超过 50 个字符
- 首字母小写，结尾不加句号
- 使用祈使语气（如：添加、修复、更新）

### 正文（Body）

可选，用于详细说明：

- 使用中文
- 说明变更的动机和与之前行为的对比
- 每行不超过 72 个字符
- 可以多行

### 脚注（Footer）

可选，用于：

- 关闭 Issue：`Closes #123`
- 破坏性变更：`BREAKING CHANGE: 描述变更`

## 提交示例

### 示例 1: 新功能

```
feat(google_photos): 添加照片自动同步功能

实现了定时任务，每 60 分钟自动同步 Google 相册中的新照片
支持断点续传和增量更新
```

### 示例 2: 修复 bug

```
fix(youtube): 修复 YouTube 嵌入视频无法播放的问题

添加 Referrer-Policy 响应头，解决 YouTube 错误 153
更新 Permissions-Policy 以支持 iframe 嵌入
```

### 示例 3: 文档更新

```
docs: 更新 Google Photos API 配置指南

添加 OAuth 同意屏幕配置步骤
补充测试用户添加的详细说明
```

### 示例 4: 代码重构

```
refactor(config): 重构配置管理类

将配置加载逻辑提取到独立方法
改进错误处理和日志记录
```

### 示例 5: 性能优化

```
perf(cache): 优化照片缓存机制

使用异步下载减少阻塞时间
添加缓存大小限制和清理策略
```

### 示例 6: 样式调整

```
style: 统一代码格式

使用 black 格式化所有 Python 文件
调整导入顺序符合 PEP 8
```

### 示例 7: 测试

```
test(api): 添加认证 API 单元测试

测试登录、登出和密码验证功能
覆盖正常流程和异常情况
```

### 示例 8: 配置变更

```
config: 更新默认缓存大小限制

将 max_cache_gb 从 2GB 调整为 5GB
更新配置文件示例
```

## Git 工作流规范

### 分支命名

- **主分支**: `main` 或 `master`
- **功能分支**: `feat/功能名称`，如 `feat/google-photos-sync`
- **修复分支**: `fix/问题描述`，如 `fix/youtube-embed-error`
- **文档分支**: `docs/文档主题`，如 `docs/api-setup-guide`
- **重构分支**: `refactor/重构内容`，如 `refactor/config-management`

### 提交频率

- **小而频繁**: 每完成一个小功能或修复就提交
- **逻辑完整**: 每次提交应该是一个完整的逻辑单元
- **可回滚**: 每次提交后代码应该可以正常运行

### 提交前检查

提交前必须：

1. **代码检查**
   - 确保代码符合 PEP 8 规范
   - 确保没有语法错误
   - 确保没有未使用的导入
   - **确保代码注释使用中文**

2. **测试**
   - 运行相关测试（如果有）
   - 手动测试新功能或修复

3. **文档**
   - 更新相关文档（如 README、API 文档）
   - 添加必要的注释

4. **提交信息**
   - 检查提交信息格式是否正确
   - 确保提交信息清晰明了

## 最佳实践

### 1. 提交粒度

- ✅ **好的做法**: 每个提交只做一件事
  ```
  feat(api): 添加用户认证端点
  fix(config): 修复配置文件路径解析错误
  ```

- ❌ **不好的做法**: 一个提交包含多个不相关的变更
  ```
  feat: 添加认证和修复配置错误
  ```

### 2. 提交信息清晰

- ✅ **好的做法**: 清晰描述做了什么
  ```
  fix(youtube): 修复视频加载失败的问题
  ```

- ❌ **不好的做法**: 模糊不清的描述
  ```
  fix: 修复了一些问题
  ```

### 3. 使用中文

- ✅ **好的做法**: 使用中文描述，便于团队理解
  ```
  feat(google_photos): 添加照片轮播功能
  ```

- ❌ **不好的做法**: 使用英文或拼音
  ```
  feat: add photo slideshow
  feat: tianjia zhaopian lunbo
  ```

### 4. 避免无意义的提交

- ❌ **避免**: 提交信息没有实际意义
  ```
  update
  fix bug
  wip
  ```

### 5. 及时提交

- ✅ **好的做法**: 完成一个功能就提交
- ❌ **不好的做法**: 累积大量变更后一次性提交

## 提交信息模板

可以使用以下模板：

```
<类型>(<范围>): <简短描述>

<详细描述（可选）>

<相关 Issue 或变更说明（可选）>
```

## 常见错误

### 错误 1: 类型使用不当

- ❌ `update: 更新配置` → ✅ `config: 更新默认配置`
- ❌ `change: 修改代码` → ✅ `refactor: 重构配置管理模块`

### 错误 2: 主题过长

- ❌ `fix: 修复了当用户在设置页面点击保存按钮时出现的配置无法保存的问题` 
- ✅ `fix(settings): 修复配置保存失败的问题`

### 错误 3: 主题使用过去式

- ❌ `feat: 添加了照片缓存功能`
- ✅ `feat(cache): 添加照片缓存功能`

### 错误 4: 主题结尾有句号

- ❌ `fix: 修复 YouTube 播放错误。`
- ✅ `fix(youtube): 修复 YouTube 播放错误`

## 工具推荐

### Git Hooks

可以使用 Git hooks 自动检查提交信息格式：

```bash
#!/bin/sh
# .git/hooks/commit-msg

commit_msg=$(cat "$1")
pattern="^(feat|fix|docs|style|refactor|perf|test|chore|ci|config)(\(.+\))?: .{1,50}"

if ! echo "$commit_msg" | grep -qE "$pattern"; then
    echo "❌ 提交信息格式不正确！"
    echo "格式: <类型>(<范围>): <主题>"
    echo "类型: feat, fix, docs, style, refactor, perf, test, chore, ci, config"
    exit 1
fi
```

### Commitizen

可以使用 Commitizen 工具辅助生成规范的提交信息：

```bash
# 安装
pip install commitizen

# 使用
cz commit
```

## 总结

遵循这些 Git 规范可以：

- 📝 让提交历史清晰易读
- 🔍 快速定位问题和变更
- 👥 便于团队协作和代码审查
- 📊 自动生成变更日志
- 🚀 提高项目维护效率

记住：**好的提交信息是项目文档的重要组成部分！**
