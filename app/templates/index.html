{% extends "base.html" %}

{% block title %}Lookoukwindow - é‡‘èä¿¡æ¯å±{% endblock %}

{% block content %}
<!-- å·¦ä¾§é¢æ¿ï¼šç»¼åˆä¿¡æ¯(ä¸Š) + ç›´æ’­(ä¸­) + é‡‘è(ä¸‹) -->
<div class="main-content dashboard-left">
    <!-- ä¸Šéƒ¨ï¼šç»¼åˆç”Ÿæ´»ä¿¡æ¯æ  (ç´§å‡‘) -->
    <div class="dashboard-top">
        <div class="info-left">
            <div class="time-display-compact" id="time-display" onclick="toggleTimeFormat()">00:00</div>
            <div class="date-compact">
                <div id="date-solar">2025/01/01 å‘¨ä¸€</div>
                <div id="date-lunar-ganzhi" style="font-size: 0.9em; color: #aaa;">è…Šæœˆåˆå…« ä¹™å·³å¹´</div>
            </div>
        </div>
        <div class="info-right">
            <div class="weather-compact">
                <div id="weather-icon" style="font-size: 2rem;">ğŸŒ¤ï¸</div>
                <div class="weather-text">
                    <div id="weather-temp" style="font-weight: bold;">--Â°C</div>
                    <div id="weather-location" style="font-size: 0.8rem; color: #aaa;">{{ weather_config.get('location_name', 'åŒ—äº¬å¸‚') }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸­éƒ¨ï¼šç›´æ’­ (Flex grow è‡ªåŠ¨å¡«å……) -->
    <div class="youtube-container">
        <div id="youtube-loading" style="display: flex; align-items: center; justify-content: center; height: 100%; color: #fff;">
            <div>æ­£åœ¨åŠ è½½NASAç›´æ’­...</div>
        </div>
        <iframe 
            id="youtube-iframe"
            class="youtube-iframe"
            src=""
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share; unload"
            allowfullscreen
            referrerpolicy="strict-origin-when-cross-origin"
            frameborder="0"
            title="YouTube video player"
            style="display: none;">
        </iframe>
    </div>

    <!-- ä¸‹éƒ¨ï¼šé‡‘èä¿¡æ¯é¢æ¿ -->
    <div class="dashboard-bottom-finance">
        <!-- 1. æŒ‡æ•°æ  (æ— ç¼æ»šåŠ¨è·‘é©¬ç¯) -->
        <div class="indices-ticker" id="indices-container">
            <!-- åŠ¨æ€ç”Ÿæˆ .indices-track -->
            <div class="loading-text" style="padding: 10px; color: #999;">åŠ è½½æŒ‡æ•°æ•°æ®...</div>
        </div>
        
        <!-- 2. ä¸ªè‚¡è½®æ’­ -->
        <div class="stock-carousel" id="stock-carousel">
            <div class="stock-info">
                <div class="stock-name-price">
                    <span id="stock-name">--</span>
                    <span id="stock-price">--</span>
                </div>
                <div class="stock-change" id="stock-change">--</div>
            </div>
            <div class="stock-chart-container">
                <canvas id="stockChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- å³ä¾§é¢æ¿ï¼šç›¸å†Œ -->
<div class="sidebar">
    <div class="photo-container" id="photo-container">
        <div class="loading">åŠ è½½ä¸­...</div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* å¸ƒå±€é‡æ„ */
    .dashboard-left {
        display: flex;
        flex-direction: column;
        background-color: #000;
        height: 100%;
    }

    /* Top Info Bar */
    .dashboard-top {
        flex: 0 0 auto;
        padding: 15px 25px;
        background: linear-gradient(to bottom, rgba(40,40,40,0.95), rgba(20,20,20,0.8));
        color: #fff;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .info-left {
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .time-display-compact {
        font-size: 3.5rem;
        font-weight: 700;
        font-family: "Segoe UI", Roboto, monospace;
        line-height: 1;
        cursor: pointer;
    }

    .date-compact {
        display: flex;
        flex-direction: column;
        font-size: 1.1rem;
    }

    .info-right {
        display: flex;
        align-items: center;
    }

    .weather-compact {
        display: flex;
        align-items: center;
        gap: 10px;
        text-align: right;
    }

    /* Mid Video */
    .youtube-container {
        flex: 1;
        width: 100%;
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        background: #000;
        overflow: hidden;
    }
    
    .youtube-iframe {
        aspect-ratio: 16/9;
        width: 100%;
        height: auto;
        max-height: 100%;
        max-width: 100%; 
    }

    /* Bottom Finance */
    .dashboard-bottom-finance {
        flex: 0 0 35%;
        min-height: 250px;
        background: linear-gradient(to top, rgba(30,30,30,0.95), rgba(10,10,10,0.9));
        border-top: 1px solid rgba(255,255,255,0.1);
        padding: 15px 0; /* ç§»é™¤å·¦å³ padding ä»¥ä¾¿è·‘é©¬ç¯è´´è¾¹ */
        display: flex;
        flex-direction: column;
        gap: 15px;
        overflow: hidden;
    }

    /* Indices Ticker Marquee */
    .indices-ticker {
        width: 100%;
        overflow: hidden;
        position: relative;
        padding: 0 20px; /* æ¢å¤è§†è§‰ä¸Šçš„ padding */
        mask-image: linear-gradient(to right, transparent, black 2%, black 98%, transparent);
        -webkit-mask-image: linear-gradient(to right, transparent, black 2%, black 98%, transparent);
    }

    .indices-track {
        display: flex;
        gap: 20px;
        width: max-content;
        /* animation å°†åœ¨ JS ä¸­æ ¹æ®å®½åº¦åŠ¨æ€è®¾ç½®ï¼Œé¿å…è¿‡å¿«æˆ–è¿‡æ…¢ */
        animation: marquee 30s linear infinite; 
    }
    
    .indices-track:hover {
        animation-play-state: paused;
    }

    @keyframes marquee {
        0% { transform: translateX(0); }
        100% { transform: translateX(-50%); } /* ç§»åŠ¨ä¸€åŠï¼ˆå³ç¬¬ä¸€ç»„å†…å®¹çš„é•¿åº¦ï¼‰ */
    }

    .index-card {
        background: rgba(255,255,255,0.08);
        padding: 10px 15px;
        border-radius: 6px;
        min-width: 140px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        flex-shrink: 0; /* é˜²æ­¢è¢«å‹ç¼© */
    }

    .index-name { font-size: 0.9rem; color: #aaa; margin-bottom: 4px; white-space: nowrap; }
    .index-price { font-size: 1.2rem; font-weight: bold; }
    .index-change { font-size: 1rem; }
    
    .up { color: #e74c3c; }
    .down { color: #2ecc71; }

    /* Stock Carousel */
    .stock-carousel {
        flex: 1;
        display: flex;
        gap: 20px;
        background: rgba(0,0,0,0.3);
        border-radius: 8px;
        padding: 15px;
        margin: 0 20px; /* æ¢å¤å·¦å³è¾¹è· */
        align-items: center;
    }

    .stock-info {
        min-width: 180px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .stock-name-price {
        display: flex;
        flex-direction: column;
        margin-bottom: 5px;
    }
    
    #stock-name { font-size: 1.4rem; color: #ddd; margin-bottom: 5px; }
    #stock-price { font-size: 2.2rem; font-weight: bold; }
    #stock-change { font-size: 1.3rem; }

    .stock-chart-container {
        flex: 1;
        height: 100%;
        position: relative;
        min-width: 0;
    }

    /* Photo Styles */
    .photo-list { padding: 10px; }
    .photo-item { margin-bottom: 10px; cursor: pointer; border-radius: 4px; overflow: hidden; transition: transform 0.2s; }
    .photo-item:hover { transform: scale(1.02); }
    .photo-item img { width: 100%; height: auto; display: block; }
    
    .photo-metadata {
        position: absolute;
        bottom: 20px;
        left: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.7);
        padding: 15px;
        border-radius: 8px;
        font-size: 14px;
    }
    
    .photo-nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(0, 0, 0, 0.5);
        border: none;
        color: #fff;
        font-size: 24px;
        padding: 20px 15px;
        cursor: pointer;
        z-index: 100;
    }
    
    .photo-nav.prev { left: 20px; }
    .photo-nav.next { right: 20px; }
    
    .error { color: #ff4444; padding: 20px; text-align: center; }
</style>
{% endblock %}

{% block extra_js %}
<!-- å¼•å…¥åº“ -->
<script src="https://cdn.jsdelivr.net/npm/lunar-javascript@1.6.12/lunar.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // æŠ‘åˆ¶é”™è¯¯æ—¥å¿—
    const originalError = console.error;
    console.error = function(...args) {
        const errorMsg = args.join(' ');
        if (errorMsg.includes('inspector.js') || errorMsg.includes('XMLHttpRequest') || errorMsg.includes('responseText') || errorMsg.includes('InvalidStateError')) return;
        originalError.apply(console, args);
    };
    
    const API_BASE = '/api';
    
    // é…ç½®
    let is24Hour = {{ 'true' if time_format == '24h' else 'false' }};
    const weatherLat = {{ weather_config.get('latitude', 39.73) }};
    const weatherLon = {{ weather_config.get('longitude', 116.33) }};

    // ==================== 1. æ—¥æœŸæ—¶é—´é€»è¾‘ ====================
    function updateTime() {
        const now = new Date();
        
        // Time
        let hours = now.getHours();
        const minutes = String(now.getMinutes()).padStart(2, '0');
        let ampm = '';
        if (!is24Hour) {
            ampm = hours >= 12 ? ' PM' : ' AM';
            hours = hours % 12;
            hours = hours ? hours : 12;
        }
        hours = String(hours).padStart(2, '0');
        document.getElementById('time-display').textContent = `${hours}:${minutes}${ampm}`;

        // Date
        const days = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
        document.getElementById('date-solar').textContent = 
            `${now.getFullYear()}/${now.getMonth()+1}/${now.getDate()} ${days[now.getDay()]}`;

        // Lunar
        if (window.Lunar) {
            const lunar = Lunar.fromDate(now);
            document.getElementById('date-lunar-ganzhi').textContent = 
                `${lunar.getMonthInChinese()}æœˆ${lunar.getDayInChinese()} Â· ${lunar.getYearInGanZhi()}å¹´ [${lunar.getYearShengXiao()}]`;
        }
    }
    function toggleTimeFormat() { is24Hour = !is24Hour; updateTime(); }
    setInterval(updateTime, 1000);
    updateTime();

    // ==================== 2. å¤©æ°”é€»è¾‘ ====================
    const weatherCodes = { 0:'â˜€ï¸',1:'ğŸŒ¤ï¸',2:'â›…',3:'â˜ï¸',45:'ğŸŒ«ï¸',48:'â„ï¸',51:'ğŸŒ§ï¸',53:'ğŸŒ§ï¸',55:'ğŸŒ§ï¸',61:'ğŸŒ§ï¸',63:'ğŸŒ§ï¸',65:'ğŸŒ§ï¸',80:'ğŸŒ¦ï¸',95:'â›ˆï¸' };
    async function updateWeather() {
        try {
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${weatherLat}&longitude=${weatherLon}&current=temperature_2m,weather_code&timezone=auto`;
            const res = await fetch(url);
            const data = await res.json();
            if (data.current) {
                const temp = Math.round(data.current.temperature_2m);
                const icon = weatherCodes[data.current.weather_code] || 'ğŸŒˆ';
                document.getElementById('weather-temp').textContent = `${temp}Â°C`;
                document.getElementById('weather-icon').textContent = icon;
            }
        } catch (e) { console.error("å¤©æ°”é”™è¯¯", e); }
    }
    updateWeather();
    setInterval(updateWeather, 1800000);

    // ==================== 3. é‡‘èé€»è¾‘ ====================
    let stockChart = null;
    let watchlist = [];
    let currentStockIndex = 0;

    // è·å–æŒ‡æ•°å¹¶åˆ›å»ºè·‘é©¬ç¯
    async function updateIndices() {
        try {
            const res = await fetch(`${API_BASE}/finance/indices`);
            const data = await res.json();
            const container = document.getElementById('indices-container');
            container.innerHTML = '';
            
            if (data.length === 0) {
                container.innerHTML = '<div style="color:#999; padding:10px;">æš‚æ— æŒ‡æ•°æ•°æ®</div>';
                return;
            }

            // åˆ›å»ºè½¨é“
            const track = document.createElement('div');
            track.className = 'indices-track';
            
            // ç”Ÿæˆå¡ç‰‡ HTML
            const createCardsHtml = (items) => {
                return items.map(idx => {
                    const isUp = idx.change >= 0;
                    const colorClass = isUp ? 'up' : 'down';
                    const sign = isUp ? '+' : '';
                    return `
                        <div class="index-card">
                            <div class="index-name">${idx.name}</div>
                            <div class="index-price ${colorClass}">${idx.price.toFixed(2)}</div>
                            <div class="index-change ${colorClass}">${sign}${idx.change_percent.toFixed(2)}%</div>
                        </div>
                    `;
                }).join('');
            };

            // å¡«å……ä¸¤ç»„æ•°æ®ä»¥å®ç°æ— ç¼è¡”æ¥
            track.innerHTML = createCardsHtml(data) + createCardsHtml(data);
            container.appendChild(track);
            
            // åŠ¨æ€è°ƒæ•´åŠ¨ç”»é€Ÿåº¦
            // å‡è®¾æ¯ä¸ªå¡ç‰‡å¤§æ¦‚ 160px (140px width + 20px gap)
            const totalWidth = data.length * 160; 
            // é€Ÿåº¦æ§åˆ¶: 50px/s
            const duration = Math.max(totalWidth / 50, 10); 
            track.style.animationDuration = `${duration}s`;

        } catch (e) { console.error("æŒ‡æ•°æ›´æ–°å¤±è´¥", e); }
    }

    // è·å–è‡ªé€‰è‚¡åˆ—è¡¨
    async function loadWatchlist() {
        try {
            const res = await fetch(`${API_BASE}/finance/watchlist`);
            watchlist = await res.json();
            if (watchlist.length > 0) {
                loadNextStock();
                setInterval(loadNextStock, 15000); // æ¯15ç§’åˆ‡æ¢ä¸€åªè‚¡ç¥¨
            } else {
                document.getElementById('stock-name').textContent = "æ— è‡ªé€‰è‚¡";
            }
        } catch (e) { console.error("è‡ªé€‰è‚¡åˆ—è¡¨å¤±è´¥", e); }
    }

    // åŠ è½½ä¸‹ä¸€åªè‚¡ç¥¨å¹¶ç»˜å›¾
    async function loadNextStock() {
        if (watchlist.length === 0) return;
        
        const stock = watchlist[currentStockIndex];
        currentStockIndex = (currentStockIndex + 1) % watchlist.length;
        
        try {
            const res = await fetch(`${API_BASE}/finance/stock/${stock.symbol}?name=${encodeURIComponent(stock.name)}`);
            const data = await res.json();
            
            // æ›´æ–°æ–‡å­—
            const isUp = data.change >= 0;
            const color = isUp ? '#e74c3c' : '#2ecc71';
            const sign = isUp ? '+' : '';
            
            document.getElementById('stock-name').textContent = data.name;
            document.getElementById('stock-price').textContent = data.price.toFixed(2);
            document.getElementById('stock-price').style.color = color;
            document.getElementById('stock-change').textContent = `${sign}${data.change.toFixed(2)} (${sign}${data.change_percent.toFixed(2)}%)`;
            document.getElementById('stock-change').style.color = color;
            
            // ç»˜åˆ¶å›¾è¡¨
            renderChart(data.history, color);
            
        } catch (e) { console.error(`ä¸ªè‚¡ ${stock.name} åŠ è½½å¤±è´¥`, e); }
    }

    function renderChart(dataPoints, lineColor) {
        const ctx = document.getElementById('stockChart').getContext('2d');
        
        if (stockChart) {
            stockChart.destroy();
        }
        
        // åˆ›å»ºæ¸å˜
        const gradient = ctx.createLinearGradient(0, 0, 0, 200);
        gradient.addColorStop(0, lineColor.replace(')', ', 0.5)').replace('rgb', 'rgba'));
        gradient.addColorStop(1, 'rgba(0,0,0,0)');

        stockChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: new Array(dataPoints.length).fill(''),
                datasets: [{
                    data: dataPoints,
                    borderColor: lineColor,
                    backgroundColor: gradient,
                    borderWidth: 2,
                    pointRadius: 0,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { display: false },
                    y: { 
                        display: true,
                        position: 'right',
                        grid: { color: 'rgba(255,255,255,0.05)' },
                        ticks: { color: '#666', font: {size: 10} }
                    }
                },
                animation: { duration: 1000 }
            }
        });
    }

    // åˆå§‹åŒ–
    updateIndices();
    setInterval(updateIndices, 60000); // æŒ‡æ•°æ¯åˆ†é’Ÿæ›´æ–°
    loadWatchlist();

    // ==================== 4. åŸæœ‰é€»è¾‘ (YouTube + Photos) ====================
    let currentChannel = '{{ default_channel|default("NASA TV") }}';
    let photos = [];
    let currentPhotoIndex = 0;
    let slideshowInterval = null;
    const slideshowDelay = ({{ slideshow_interval_seconds|default(10) }}) * 1000;
    const showMetadata = {{ 'true' if show_metadata else 'false' }};

    async function loadYouTubeChannel(channelName) {
        try {
            const encoded = encodeURIComponent(channelName);
            const res = await fetch(`${API_BASE}/youtube/embed/${encoded}`);
            const data = await res.json();
            const iframe = document.getElementById('youtube-iframe');
            if (iframe && data.embed_url) {
                const urlObj = new URL(data.embed_url);
                urlObj.searchParams.set('autoplay', '1');
                urlObj.searchParams.set('mute', '0');
                urlObj.searchParams.delete('enablejsapi');
                iframe.src = urlObj.toString();
                iframe.style.display = 'block';
                document.getElementById('youtube-loading').style.display = 'none';
            }
        } catch(e) {}
    }

    async function loadPhotos() {
        try {
            const res = await fetch(`${API_BASE}/albums/slideshow`);
            photos = await res.json();
            if (photos.length > 0) { displayPhoto(0); startSlideshow(); }
            else { document.getElementById('photo-container').innerHTML = '<div class="error">æš‚æ— ç…§ç‰‡<br>è¯·åœ¨â€œè®¾ç½®â€ä¸­åˆ›å»ºç›¸å†Œå¹¶ä¸Šä¼ ç…§ç‰‡</div>'; }
        } catch(e) {}
    }

    function displayPhoto(index) {
        if (photos.length === 0) return;
        currentPhotoIndex = index;
        const photo = photos[index];
        const container = document.getElementById('photo-container');
        const photoUrl = photo.url;
        
        let metadataHtml = '';
        if (showMetadata) {
             let timeStr = '';
             if (photo.created_at) {
                 try { timeStr = new Date(photo.created_at).toLocaleString('zh-CN'); } catch(e) {}
             }
             metadataHtml = `
                <div class="photo-metadata">
                    <div>ç›¸å†Œ: ${photo.album_name || ''}</div>
                    <div>æ—¶é—´: ${timeStr}</div>
                    <div>${index + 1} / ${photos.length}</div>
                </div>`;
        }
        container.innerHTML = `
            <button class="photo-nav prev" onclick="prevPhoto()">â€¹</button>
            <img src="${photoUrl}" class="photo-image" style="object-fit:contain;width:100%;height:100%;max-height:100%;" loading="eager">
            <button class="photo-nav next" onclick="nextPhoto()">â€º</button>
            ${metadataHtml}`;
    }
    
    function prevPhoto() {
        if (photos.length === 0) return;
        currentPhotoIndex = (currentPhotoIndex - 1 + photos.length) % photos.length;
        displayPhoto(currentPhotoIndex);
        resetSlideshow();
    }
    
    function nextPhoto() {
        if (photos.length === 0) return;
        currentPhotoIndex = (currentPhotoIndex + 1) % photos.length;
        displayPhoto(currentPhotoIndex);
        resetSlideshow();
    }
    
    function startSlideshow() {
        if (slideshowInterval) clearInterval(slideshowInterval);
        slideshowInterval = setInterval(() => {
             nextPhoto();
        }, slideshowDelay);
    }
    
    function resetSlideshow() {
        if (slideshowInterval) clearInterval(slideshowInterval);
        startSlideshow();
    }

    // é”®ç›˜æ§åˆ¶
    document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft') { prevPhoto(); }
        else if (e.key === 'ArrowRight') { nextPhoto(); }
        else if (e.key === 'Escape') {
            if (document.fullscreenElement) document.exitFullscreen();
        }
    });

    window.addEventListener('DOMContentLoaded', () => {
        if (currentChannel) loadYouTubeChannel(currentChannel);
        loadPhotos();
    });
</script>
{% endblock %}