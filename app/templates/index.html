{% extends "base.html" %}

{% block title %}Lookoukwindow - NASA 太空直播{% endblock %}

{% block content %}
<!-- 左侧面板：时间(上) + 直播(中) + 天气(下) -->
<div class="main-content dashboard-left">
    <!-- 上部：日期时间 -->
    <div class="dashboard-top">
        <div class="time-display" id="time-display" onclick="toggleTimeFormat()">00:00:00</div>
        <div class="date-row">
            <div class="date-left">
                <div class="date-solar" id="date-solar">2025年 1月 1日 星期一</div>
                <div class="date-lunar-text" id="date-lunar-text">腊月初八</div>
                <div class="date-ganzhi" id="date-ganzhi">乙巳年 【蛇年】</div>
            </div>
            <div class="date-right">
                <div class="date-big-day" id="date-big-day">1</div>
            </div>
        </div>
    </div>

    <!-- 中部：直播 -->
    <div class="youtube-container">
        <div id="youtube-loading" style="display: flex; align-items: center; justify-content: center; height: 100%; color: #fff;">
            <div>正在加载NASA直播...</div>
        </div>
        <iframe 
            id="youtube-iframe"
            class="youtube-iframe"
            src=""
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share; unload"
            allowfullscreen
            referrerpolicy="strict-origin-when-cross-origin"
            frameborder="0"
            title="YouTube video player"
            style="display: none;">
        </iframe>
    </div>

    <!-- 下部：天气 -->
    <div class="dashboard-bottom" id="weather-container">
        <div class="weather-main">
            <div class="weather-temp" id="weather-temp">--°C</div>
            <div class="weather-desc" id="weather-desc">加载中...</div>
        </div>
        <div class="weather-details">
            <div id="weather-location">{{ weather_config.get('location_name', '北京市大兴区') }}</div>
            <div id="weather-meta">湿度: --% | 风速: -- km/h</div>
        </div>
    </div>
</div>

<!-- 右侧面板：相册 -->
<div class="sidebar">
    <div class="photo-container" id="photo-container">
        <div class="loading">加载中...</div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* 布局重构 */
    .dashboard-left {
        display: flex;
        flex-direction: column;
        background-color: #000;
        height: 100%;
    }

    .dashboard-top {
        flex: 0 0 auto; /* 高度自适应内容 */
        padding: 20px 30px;
        background: linear-gradient(to bottom, rgba(30,30,30,0.9), rgba(0,0,0,0));
        color: #fff;
        min-height: 180px;
    }

    .youtube-container {
        flex: 1; /* 占据剩余空间，但受限于aspect-ratio */
        width: 100%;
        position: relative;
        /* 保持16:9比例，但在flex布局中可能需要特殊处理 */
        display: flex;
        justify-content: center;
        background: #000;
    }
    
    /* 强制视频保持16:9比例居中 */
    .youtube-iframe {
        aspect-ratio: 16/9;
        width: 100%;
        height: auto;
        max-height: 100%;
        margin: auto;
    }

    .dashboard-bottom {
        flex: 0 0 auto;
        padding: 20px 30px;
        background: linear-gradient(to top, rgba(30,30,30,0.9), rgba(0,0,0,0));
        color: #fff;
        display: flex;
        justify-content: space-between;
        align-items: center;
        min-height: 100px;
    }

    /* 时间日期样式 */
    .time-display {
        font-size: 4.5rem;
        font-weight: 700;
        font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        line-height: 1;
        margin-bottom: 10px;
        cursor: pointer;
        letter-spacing: 2px;
    }

    .date-row {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }

    .date-left {
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .date-solar {
        font-size: 1.4rem;
        margin-bottom: 5px;
        color: #ddd;
    }

    .date-lunar-text {
        font-size: 1.2rem;
        color: #aaa;
        margin-bottom: 2px;
    }

    .date-ganzhi {
        font-size: 1rem;
        color: #888;
    }

    .date-big-day {
        font-size: 5rem;
        font-weight: bold;
        line-height: 0.8;
        color: #fff;
        opacity: 0.9;
        padding-right: 10px;
    }

    /* 天气样式 */
    .weather-main {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .weather-temp {
        font-size: 3rem;
        font-weight: bold;
    }

    .weather-desc {
        font-size: 1.2rem;
        color: #ccc;
    }

    .weather-details {
        text-align: right;
        font-size: 1rem;
        color: #aaa;
    }
    
    #weather-location {
        font-size: 1.2rem;
        color: #fff;
        margin-bottom: 4px;
    }

    /* 相册样式保持不变 */
    .photo-list {
        padding: 10px;
    }
    
    .photo-item {
        margin-bottom: 10px;
        cursor: pointer;
        border-radius: 4px;
        overflow: hidden;
        transition: transform 0.2s;
    }
    
    .photo-item:hover {
        transform: scale(1.02);
    }
    
    .photo-item img {
        width: 100%;
        height: auto;
        display: block;
    }
</style>
{% endblock %}

{% block extra_js %}
<!-- 引入农历库 -->
<script src="https://cdn.jsdelivr.net/npm/lunar-javascript@1.6.12/lunar.js"></script>

<script>
    // 抑制 YouTube iframe 内部的错误日志（不影响功能）
    const originalError = console.error;
    console.error = function(...args) {
        // 过滤掉 YouTube 内部的错误
        const errorMsg = args.join(' ');
        if (errorMsg.includes('inspector.js') || 
            errorMsg.includes('XMLHttpRequest') ||
            errorMsg.includes('responseText') ||
            errorMsg.includes('InvalidStateError')) {
            // 静默处理 YouTube 内部错误
            return;
        }
        originalError.apply(console, args);
    };
    
    const API_BASE = '/api';
    let currentChannel = '{{ default_channel|default("NASA TV") }}';
    let photos = [];
    let currentPhotoIndex = 0;
    let slideshowInterval = null;
    const slideshowDelay = ({{ slideshow_interval_seconds|default(10) }}) * 1000;
    const showMetadata = {{ 'true' if show_metadata else 'false' }};
    
    // 配置
    let is24Hour = {{ 'true' if time_format == '24h' else 'false' }};
    const weatherLat = {{ weather_config.get('latitude', 39.73) }};
    const weatherLon = {{ weather_config.get('longitude', 116.33) }};

    // --- 时间与日期逻辑 ---
    function updateTime() {
        const now = new Date();
        
        // 1. 更新时间
        let hours = now.getHours();
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        let ampm = '';

        if (!is24Hour) {
            ampm = hours >= 12 ? ' PM' : ' AM';
            hours = hours % 12;
            hours = hours ? hours : 12; // the hour '0' should be '12'
        }
        hours = String(hours).padStart(2, '0');
        document.getElementById('time-display').textContent = `${hours}:${minutes}:${seconds}${ampm}`;

        // 2. 更新日期 (如果跨天)
        // 为了性能，可以不用每秒都重新计算农历，但这里简单起见直接更新
        const year = now.getFullYear();
        const month = now.getMonth() + 1;
        const date = now.getDate();
        const day = now.getDay();
        const days = ['日', '一', '二', '三', '四', '五', '六'];
        
        document.getElementById('date-solar').textContent = `${year}年 ${month}月 ${date}日 星期${days[day]}`;
        document.getElementById('date-big-day').textContent = date;

        // 3. 更新农历 (依赖 lunar.js)
        if (window.Lunar) {
            const lunar = Lunar.fromDate(now);
            const monthStr = lunar.getMonthInChinese();
            const dayStr = lunar.getDayInChinese();
            document.getElementById('date-lunar-text').textContent = `${monthStr}月${dayStr}`;
            
            const yearGanZhi = lunar.getYearInGanZhi();
            const shengXiao = lunar.getYearShengXiao();
            const monthGanZhi = lunar.getMonthInGanZhi();
            const dayGanZhi = lunar.getDayInGanZhi();
            
            document.getElementById('date-ganzhi').textContent = `${yearGanZhi}年 【${shengXiao}年】 ${monthGanZhi}月 ${dayGanZhi}日`;
        }
    }

    function toggleTimeFormat() {
        is24Hour = !is24Hour;
        updateTime();
    }

    setInterval(updateTime, 1000);
    updateTime(); // Init immediately

    // --- 天气逻辑 (Open-Meteo) ---
    // WMO Weather interpretation codes (WW)
    const weatherCodes = {
        0: '晴', 1: '晴间多云', 2: '多云', 3: '阴',
        45: '雾', 48: '白霜',
        51: '小毛毛雨', 53: '毛毛雨', 55: '大毛毛雨',
        61: '小雨', 63: '中雨', 65: '大雨',
        80: '阵雨', 81: '中阵雨', 82: '大阵雨',
        71: '小雪', 73: '中雪', 75: '大雪',
        95: '雷雨', 96: '雷雨伴冰雹', 99: '大雷雨伴冰雹'
    };

    async function updateWeather() {
        try {
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${weatherLat}&longitude=${weatherLon}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m&timezone=auto`;
            const res = await fetch(url);
            const data = await res.json();
            
            if (data.current) {
                const current = data.current;
                const temp = Math.round(current.temperature_2m);
                const code = current.weather_code;
                const desc = weatherCodes[code] || '未知';
                const humidity = current.relative_humidity_2m;
                const wind = current.wind_speed_10m;

                document.getElementById('weather-temp').textContent = `${temp}°C`;
                document.getElementById('weather-desc').textContent = desc;
                document.getElementById('weather-meta').textContent = `湿度: ${humidity}% | 风速: ${wind} km/h`;
            }
        } catch (e) {
            console.error("获取天气失败", e);
            document.getElementById('weather-desc').textContent = "天气获取失败";
        }
    }

    updateWeather();
    setInterval(updateWeather, 1800000); // 每30分钟更新一次

    // --- 原有功能：加载YouTube频道 ---
    async function loadYouTubeChannel(channelName) {
        try {
            console.log('正在加载YouTube频道:', channelName);
            const encodedChannelName = encodeURIComponent(channelName);
            const response = await fetch(`${API_BASE}/youtube/embed/${encodedChannelName}`);
            
            if (!response.ok) {
                throw new Error(`HTTP错误: ${response.status} ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('获取到embed URL:', data.embed_url);
            
            if (!data.embed_url) {
                throw new Error('未获取到embed URL');
            }
            
            const iframe = document.getElementById('youtube-iframe');
            const loading = document.getElementById('youtube-loading');
            
            if (iframe) {
                // 对于直播视频，简化URL参数
                let embedUrl = data.embed_url;
                
                // 处理URL参数
                const urlObj = new URL(embedUrl);
                
                // 如果是频道直播流，添加基本参数
                if (urlObj.pathname.includes('live_stream')) {
                    urlObj.searchParams.set('autoplay', '1');
                    urlObj.searchParams.set('mute', '0');
                } else {
                    // 普通视频，添加基本参数
                    urlObj.searchParams.set('autoplay', '1');
                    urlObj.searchParams.set('mute', '0');
                    // 移除可能引起问题的参数
                    urlObj.searchParams.delete('enablejsapi');
                    urlObj.searchParams.delete('rel');
                    urlObj.searchParams.delete('modestbranding');
                }
                
                embedUrl = urlObj.toString();
                
                console.log('设置YouTube iframe URL:', embedUrl);
                iframe.src = embedUrl;
                iframe.style.display = 'block';
                if (loading) {
                    loading.style.display = 'none';
                }
                console.log('YouTube iframe已设置');
            } else {
                console.error('未找到youtube-iframe元素');
                if (loading) {
                    loading.innerHTML = '<div style="color: #ff4444;">未找到视频播放器元素</div>';
                }
            }
        } catch (error) {
            console.error('加载YouTube频道失败:', error);
            const container = document.querySelector('.youtube-container');
            if (container) {
                container.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #fff; flex-direction: column; gap: 10px;">
                        <div style="font-size: 18px;">加载YouTube直播失败</div>
                        <div style="font-size: 14px; color: #999;">${error.message}</div>
                        <button onclick="location.reload()" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;">重试</button>
                    </div>
                `;
            }
        }
    }
    
    // 加载照片列表
    async function loadPhotos() {
        try {
            // 使用新的相册 API
            const response = await fetch(`${API_BASE}/albums/slideshow`);
            photos = await response.json();
            
            if (photos.length > 0) {
                displayPhoto(0);
                startSlideshow();
            } else {
                document.getElementById('photo-container').innerHTML = 
                    '<div class="error" style="text-align: center; padding: 20px;">暂无照片<br>请在“设置”中创建相册并上传照片</div>';
            }
        } catch (error) {
            console.error('加载照片失败:', error);
            document.getElementById('photo-container').innerHTML = 
                '<div class="error">加载照片失败</div>';
        }
    }
    
    // 显示照片
    function displayPhoto(index) {
        if (photos.length === 0) return;
        
        currentPhotoIndex = index;
        const photo = photos[index];
        const container = document.getElementById('photo-container');
        
        // 新 API 直接返回 url
        const photoUrl = photo.url;
        
        let metadataHtml = '';
        if (showMetadata) {
            // 格式化时间
            let timeStr = '';
            if (photo.created_at) {
                try {
                    timeStr = new Date(photo.created_at).toLocaleString('zh-CN');
                } catch(e) {}
            }
            
            const albumName = photo.album_name || '';
            
            metadataHtml = `
                <div class="photo-metadata">
                    <div>相册: ${albumName}</div>
                    <div>时间: ${timeStr}</div>
                    <div>${index + 1} / ${photos.length}</div>
                </div>
            `;
        }
        
        container.innerHTML = `
            <button class="photo-nav prev" onclick="prevPhoto()">‹</button>
            <img src="${photoUrl}" alt="${photo.filename}" class="photo-image" id="photo-image" loading="eager">
            <button class="photo-nav next" onclick="nextPhoto()">›</button>
            ${metadataHtml}
        `;
    }
    
    // 上一张照片
    function prevPhoto() {
        if (photos.length === 0) return;
        currentPhotoIndex = (currentPhotoIndex - 1 + photos.length) % photos.length;
        displayPhoto(currentPhotoIndex);
        resetSlideshow();
    }
    
    // 下一张照片
    function nextPhoto() {
        if (photos.length === 0) return;
        currentPhotoIndex = (currentPhotoIndex + 1) % photos.length;
        displayPhoto(currentPhotoIndex);
        resetSlideshow();
    }
    
    // 开始轮播
    function startSlideshow() {
        if (slideshowInterval) {
            clearInterval(slideshowInterval);
        }
        slideshowInterval = setInterval(() => {
            nextPhoto();
        }, slideshowDelay);
    }
    
    // 重置轮播
    function resetSlideshow() {
        if (slideshowInterval) {
            clearInterval(slideshowInterval);
        }
        startSlideshow();
    }
    
    // 键盘控制
    document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft') {
            prevPhoto();
        } else if (e.key === 'ArrowRight') {
            nextPhoto();
        } else if (e.key === 'Escape') {
            if (document.fullscreenElement) {
                document.exitFullscreen();
            }
        }
    });
    
    // 初始化
    window.addEventListener('DOMContentLoaded', () => {
        console.log('页面加载完成，默认频道:', currentChannel);
        if (currentChannel) {
            loadYouTubeChannel(currentChannel);
        } else {
            console.warn('未设置默认频道，尝试加载第一个可用频道');
            // 尝试获取频道列表并加载第一个
            fetch(`${API_BASE}/youtube/channels`)
                .then(res => res.json())
                .then(data => {
                    if (data.channels && data.channels.length > 0) {
                        const firstChannel = data.channels[0].name;
                        console.log('加载第一个可用频道:', firstChannel);
                        loadYouTubeChannel(firstChannel);
                    }
                })
                .catch(err => console.error('获取频道列表失败:', err));
        }
        loadPhotos();
    });
</script>
{% endblock %}