{% extends "base.html" %}

{% block title %}Lookoukwindow - é‡‘èä¿¡æ¯å±{% endblock %}

{% block content %}
<!-- å·¦ä¾§é¢æ¿ï¼šç»¼åˆä¿¡æ¯(ä¸Š) + ç›´æ’­(ä¸­) + é‡‘è(ä¸‹) -->
<div class="main-content dashboard-left">
    <!-- ä¸Šéƒ¨ï¼šç»¼åˆç”Ÿæ´»ä¿¡æ¯æ  (ç´§å‡‘) -->
    <div class="dashboard-top">
        <div class="info-left">
            <div class="date-time-group">
                <div class="date-compact">
                    <span id="date-solar">2025/01/01 å‘¨ä¸€</span>
                    <span id="date-lunar-ganzhi" style="font-size: 0.85em; color: #aaa; margin-left: 10px;">è…Šæœˆåˆå…« ä¹™å·³å¹´</span>
                </div>
                <div class="time-display-compact" id="time-display" onclick="toggleTimeFormat()">00:00:00</div>
            </div>
        </div>
        <div class="info-right">
            <div class="weather-container">
                <div class="weather-current">
                    <div id="weather-icon" style="font-size: 2.5rem;">ğŸŒ¤ï¸</div>
                    <div class="weather-text">
                        <div id="weather-temp" style="font-weight: bold; font-size: 1.5rem;">--Â°C</div>
                        <div id="weather-location" style="font-size: 0.8rem; color: #aaa;">{{ weather_config.get('location_name', 'åŒ—äº¬å¸‚') }}</div>
                    </div>
                </div>
                <!-- æœªæ¥3å°æ—¶é¢„æŠ¥ -->
                <div class="weather-forecast" id="weather-forecast">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸­éƒ¨ï¼šç›´æ’­ (Flex grow è‡ªåŠ¨å¡«å……) -->
    <div class="youtube-container">
        <div id="youtube-loading" style="display: flex; align-items: center; justify-content: center; height: 100%; color: #fff;">
            <div>æ­£åœ¨åŠ è½½NASAç›´æ’­...</div>
        </div>
        <iframe 
            id="youtube-iframe"
            class="youtube-iframe"
            src=""
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share; unload"
            allowfullscreen
            referrerpolicy="strict-origin-when-cross-origin"
            frameborder="0"
            title="YouTube video player"
            style="display: none;">
        </iframe>
    </div>

    <!-- ä¸‹éƒ¨ï¼šé‡‘èä¿¡æ¯é¢æ¿ -->
    <div class="dashboard-bottom-finance">
        <!-- 1. æŒ‡æ•°æ  (æ— ç¼æ»šåŠ¨è·‘é©¬ç¯) -->
        <div class="indices-ticker" id="indices-container">
            <!-- åŠ¨æ€ç”Ÿæˆ .indices-track -->
            <div class="loading-text" style="padding: 10px; color: #999;">åŠ è½½æŒ‡æ•°æ•°æ®...</div>
        </div>
        
        <!-- 2. ä¸ªè‚¡è½®æ’­ -->
        <div class="stock-carousel" id="stock-carousel">
            <div class="stock-info">
                <div class="stock-name-price">
                    <span id="stock-name">--</span>
                    <span id="stock-price">--</span>
                </div>
                <div class="stock-change" id="stock-change">--</div>
            </div>
            <!-- åŒå›¾è¡¨å®¹å™¨ -->
            <div class="stock-charts-wrapper">
                <div class="chart-box">
                    <div class="chart-label">åˆ†æ—¶</div>
                    <canvas id="stockChart1d"></canvas>
                </div>
                <div class="chart-box">
                    <div class="chart-label">æ—¥K(1å¹´)</div>
                    <canvas id="stockChart1y"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å³ä¾§é¢æ¿ï¼šç›¸å†Œ -->
<div class="sidebar">
    <div class="photo-container" id="photo-container">
        <div class="loading">åŠ è½½ä¸­...</div>
    </div>
</div>

<!-- Sleep Mode Overlay -->
<div id="sleep-overlay" style="display: none;">
    <div class="sleep-content">
        <div id="sleep-date-full" style="font-size: 1.8rem; color: #555; margin-bottom: 10px;">2025å¹´01æœˆ01æ—¥ æ˜ŸæœŸä¸€</div>
        <div id="sleep-time" style="font-size: 10rem; font-weight: bold; font-family: 'Segoe UI', sans-serif; color: #333; line-height: 1;">00:00:00</div>
        <div id="sleep-lunar" style="font-size: 1.5rem; color: #444; margin-top: 15px;">è…Šæœˆåˆå…« ä¹™å·³å¹´ [è›‡å¹´]</div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* Sleep Overlay */
    #sleep-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-color: #000;
        z-index: 9999;
        display: none;
        align-items: center;
        justify-content: center;
        cursor: none; /* éšè—é¼ æ ‡ */
    }
    
    .sleep-content {
        text-align: center;
        color: #333; /* é»˜è®¤æš—æ·¡é¢œè‰²ï¼Œé˜²æ­¢å¤ªäº® */
        transition: transform 1s ease-in-out; /* å¹³æ»‘ç§»åŠ¨ */
    }
    
    #sleep-time {
        font-size: 10rem;
        font-weight: bold;
        font-family: "Segoe UI", monospace;
        color: #444;
    }
    
    #sleep-date-full {
        font-size: 2rem;
        color: #222;
    }

    #sleep-lunar {
        font-size: 1.5rem;
        color: #333;
    }

    /* å¸ƒå±€é‡æ„ */
    .dashboard-left {
        display: flex;
        flex-direction: column;
        background-color: #000;
        height: 100%;
    }

    /* Top Info Bar */
    .dashboard-top {
        flex: 0 0 auto;
        padding: 15px 25px;
        background: linear-gradient(to bottom, rgba(40,40,40,0.95), rgba(20,20,20,0.8));
        color: #fff;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .info-left {
        display: flex;
        align-items: center;
    }

    .date-time-group {
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .date-compact {
        font-size: 1.1rem;
        margin-bottom: 2px;
        color: #ddd;
    }

    .time-display-compact {
        font-size: 3.2rem;
        font-weight: 700;
        font-family: "Segoe UI", Roboto, monospace;
        line-height: 1;
        cursor: pointer;
        letter-spacing: 1px;
    }

    .info-right {
        display: flex;
        align-items: center;
    }

    .weather-container {
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .weather-current {
        display: flex;
        align-items: center;
        gap: 10px;
        text-align: right;
    }

    .weather-forecast {
        display: flex;
        gap: 10px;
        border-left: 1px solid rgba(255,255,255,0.2);
        padding-left: 15px;
    }

    .forecast-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        color: #ccc;
    }
    .forecast-time { font-size: 0.7rem; margin-bottom: 2px; }
    .forecast-icon { font-size: 1.2rem; margin-bottom: 2px; }

    /* Mid Video */
    .youtube-container {
        flex: 1;
        width: 100%;
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        background: #000;
        overflow: hidden;
    }
    
    .youtube-iframe {
        aspect-ratio: 16/9;
        width: 100%;
        height: auto;
        max-height: 100%;
        max-width: 100%; 
    }

    /* Bottom Finance */
    .dashboard-bottom-finance {
        flex: 0 0 35%;
        min-height: 250px;
        background: linear-gradient(to top, rgba(30,30,30,0.95), rgba(10,10,10,0.9));
        border-top: 1px solid rgba(255,255,255,0.1);
        padding: 15px 0; 
        display: flex;
        flex-direction: column;
        gap: 10px;
        overflow: hidden;
    }

    /* Indices Ticker Marquee */
    .indices-ticker {
        width: 100%;
        overflow: hidden;
        position: relative;
        padding: 0 20px;
        mask-image: linear-gradient(to right, transparent, black 2%, black 98%, transparent);
        -webkit-mask-image: linear-gradient(to right, transparent, black 2%, black 98%, transparent);
        margin-bottom: 5px;
    }

    .indices-track {
        display: flex;
        gap: 20px;
        width: max-content;
        animation: marquee 30s linear infinite; 
    }
    
    .indices-track:hover {
        animation-play-state: paused;
    }

    @keyframes marquee {
        0% { transform: translateX(0); }
        100% { transform: translateX(-50%); } 
    }

    .index-card {
        background: rgba(255,255,255,0.08);
        padding: 8px 12px;
        border-radius: 6px;
        min-width: 130px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        flex-shrink: 0; 
    }

    .index-name { font-size: 0.8rem; color: #aaa; margin-bottom: 2px; white-space: nowrap; }
    .index-price { font-size: 1.1rem; font-weight: bold; }
    .index-change { font-size: 0.9rem; }
    
    .up { color: #e74c3c; }
    .down { color: #2ecc71; }

    /* Stock Carousel */
    .stock-carousel {
        flex: 1;
        display: flex;
        gap: 20px;
        background: rgba(0,0,0,0.3);
        border-radius: 8px;
        padding: 10px 20px;
        margin: 0 20px 10px 20px; 
        align-items: center;
        overflow: hidden;
    }

    .stock-info {
        min-width: 160px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .stock-name-price {
        display: flex;
        flex-direction: column;
        margin-bottom: 5px;
    }
    
    #stock-name { font-size: 1.3rem; color: #ddd; margin-bottom: 2px; }
    #stock-price { font-size: 2rem; font-weight: bold; }
    #stock-change { font-size: 1.2rem; }

    .stock-charts-wrapper {
        flex: 1;
        display: flex;
        gap: 15px;
        height: 100%;
        min-width: 0; /* fix flex child overflow */
    }

    .chart-box {
        flex: 1;
        position: relative;
        background: rgba(255,255,255,0.03);
        border-radius: 4px;
        padding: 5px;
        min-width: 0;
    }
    
    .chart-label {
        position: absolute;
        top: 5px;
        left: 8px;
        font-size: 10px;
        color: #888;
        pointer-events: none;
        z-index: 1;
    }

    /* Photo Styles */
    .photo-container {
        position: relative;
        width: 100%;
        height: 100%;
        background: #000;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .photo-metadata {
        position: absolute;
        bottom: 20px;
        left: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.7);
        padding: 15px;
        border-radius: 8px;
        font-size: 14px;
        z-index: 10;
        color: #fff;
    }
    
    .photo-nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(0, 0, 0, 0.5);
        border: none;
        color: #fff;
        font-size: 24px;
        padding: 20px 15px;
        cursor: pointer;
        z-index: 100;
        transition: background 0.2s;
    }
    
    .photo-nav:hover { background: rgba(0, 0, 0, 0.8); }
    .photo-nav.prev { left: 20px; }
    .photo-nav.next { right: 20px; }
    
    .error { color: #ff4444; padding: 20px; text-align: center; }
</style>
{% endblock %}

{% block extra_js %}
<!-- å¼•å…¥åº“ -->
<script src="https://cdn.jsdelivr.net/npm/lunar-javascript@1.6.12/lunar.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // æŠ‘åˆ¶é”™è¯¯æ—¥å¿—
    const originalError = console.error;
    console.error = function(...args) {
        const errorMsg = args.join(' ');
        if (errorMsg.includes('inspector.js') || errorMsg.includes('XMLHttpRequest') || errorMsg.includes('responseText') || errorMsg.includes('InvalidStateError')) return;
        originalError.apply(console, args);
    };
    
    const API_BASE = '/api';
    
    // é…ç½®
    let is24Hour = {{ 'true' if time_format == '24h' else 'false' }};
    const weatherLat = {{ weather_config.get('latitude', 39.73) }};
    const weatherLon = {{ weather_config.get('longitude', 116.33) }};
    
    // Energy Config
    // ç§»é™¤æ—§çš„é™æ€é…ç½®ï¼Œæ”¹ç”± SleepManager åŠ¨æ€ç®¡ç†
    // const energyEnabled = ... 

    // ==================== 1. æ—¥æœŸæ—¶é—´é€»è¾‘ ====================
    function updateTime() {
        const now = new Date();
        
        // Time (HH:MM:SS)
        let hours = now.getHours();
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        let ampm = '';
        
        if (!is24Hour) {
            ampm = hours >= 12 ? ' PM' : ' AM';
            hours = hours % 12;
            hours = hours ? hours : 12;
        }
        hours = String(hours).padStart(2, '0');
        
        // è°ƒæ•´å­—ä½“å¤§å°è‡ªé€‚åº”ï¼ˆå¯é€‰ï¼‰
        document.getElementById('time-display').textContent = `${hours}:${minutes}:${seconds}${ampm}`;

        // Date
        const days = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
        document.getElementById('date-solar').textContent = 
            `${now.getFullYear()}/${now.getMonth()+1}/${now.getDate()} ${days[now.getDay()]}`;

        // Lunar
        if (window.Lunar) {
            const lunar = Lunar.fromDate(now);
            document.getElementById('date-lunar-ganzhi').textContent = 
                `${lunar.getMonthInChinese()}æœˆ${lunar.getDayInChinese()} Â· ${lunar.getYearInGanZhi()}å¹´ [${lunar.getYearShengXiao()}]`;
        }
    }
    function toggleTimeFormat() { is24Hour = !is24Hour; updateTime(); }
    setInterval(updateTime, 1000);
    updateTime();

    // ==================== 2. å¤©æ°”é€»è¾‘ ====================
    const weatherCodes = { 0:'â˜€ï¸',1:'ğŸŒ¤ï¸',2:'â›…',3:'â˜ï¸',45:'ğŸŒ«ï¸',48:'â„ï¸',51:'ğŸŒ§ï¸',53:'ğŸŒ§ï¸',55:'ğŸŒ§ï¸',61:'ğŸŒ§ï¸',63:'ğŸŒ§ï¸',65:'ğŸŒ§ï¸',80:'ğŸŒ¦ï¸',95:'â›ˆï¸' };
    async function updateWeather() {
        if (window.isAppSleeping) return;
        try {
            // è¯·æ±‚å½“å‰å¤©æ°” + æœªæ¥3å¤©æ•°æ® (è¶³å¤Ÿè¦†ç›–æœªæ¥24å°æ—¶)
            // å¼ºåˆ¶ä½¿ç”¨ Asia/Shanghai æ—¶åŒº (åŒ—äº¬æ—¶é—´)
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${weatherLat}&longitude=${weatherLon}&current=temperature_2m,weather_code&hourly=temperature_2m,weather_code&timezone=Asia%2FShanghai&forecast_days=3`;
            const res = await fetch(url);
            const data = await res.json();
            
            // æ›´æ–°å½“å‰å¤©æ°”
            if (data.current) {
                const temp = Math.round(data.current.temperature_2m);
                const icon = weatherCodes[data.current.weather_code] || 'ğŸŒˆ';
                document.getElementById('weather-temp').textContent = `${temp}Â°C`;
                document.getElementById('weather-icon').textContent = icon;
            }

            // æ›´æ–°æœªæ¥ 2, 4, 6 å°æ—¶é¢„æŠ¥ (åŸºå‡†: åŒ—äº¬æ—¶é—´)
            if (data.hourly && data.hourly.time) {
                const now = new Date();
                // æ„é€ å½“å‰å°æ—¶çš„åŒ¹é…å­—ç¬¦ä¸² (YYYY-MM-DDTHH)ï¼Œå‡è®¾è®¾å¤‡ä¹Ÿæ˜¯åŒ—äº¬æ—¶é—´
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const hour = String(now.getHours()).padStart(2, '0');
                const currentHourStr = `${year}-${month}-${day}T${hour}`;

                // æ‰¾åˆ°å½“å‰æ—¶é—´åœ¨ hourly åˆ—è¡¨ä¸­çš„ç´¢å¼•
                let currentIndex = data.hourly.time.findIndex(t => t.startsWith(currentHourStr));
                
                // å¦‚æœæ²¡æ‰¾åˆ°(æˆ–è€…è·¨å¤©é—®é¢˜)ï¼Œå°è¯•æ¨¡ç³ŠåŒ¹é…æœ€è¿‘çš„æœªæ¥æ—¶é—´
                if (currentIndex === -1) {
                    // å°† API è¿”å›çš„æ—¶é—´å­—ç¬¦ä¸²è§£æä¸ºæ—¶é—´æˆ³è¿›è¡Œæ¯”è¾ƒ
                    // æ³¨æ„: new Date("YYYY-MM-DDTHH:00") åœ¨ä¸åŒæµè§ˆå™¨ä¸‹å¯¹æ— æ—¶åŒºå­—ç¬¦ä¸²è§£æè¡Œä¸ºä¸åŒ
                    // ä½†æ—¢ç„¶ url æŒ‡å®šäº† timezoneï¼Œè¿”å›çš„æ˜¯å½“åœ°æ—¶é—´å­—ç¬¦ä¸²ã€‚
                    // æˆ‘ä»¬ç®€å•æ¯”å¯¹å­—ç¬¦ä¸²å¤§å°å³å¯ (ISOæ ¼å¼æ”¯æŒå­—å…¸åºæ¯”è¾ƒ)
                    for(let i=0; i<data.hourly.time.length; i++) {
                        if (data.hourly.time[i] >= currentHourStr) {
                            currentIndex = i;
                            break;
                        }
                    }
                }
                
                // å¦‚æœè¿˜æ˜¯æ²¡æ‰¾åˆ°ï¼Œé»˜è®¤ä¸º0
                if (currentIndex === -1) currentIndex = 0;

                const forecastContainer = document.getElementById('weather-forecast');
                forecastContainer.innerHTML = '';

                // éœ€æ±‚: æœªæ¥ 2, 4, 6, 12, 24 å°æ—¶
                const offsets = [2, 4, 6, 12, 24];

                offsets.forEach(offset => {
                    const idx = currentIndex + offset;
                    if (idx < data.hourly.time.length) {
                        const timeStr = data.hourly.time[idx]; // e.g. "2025-01-01T14:00"
                        const temp = Math.round(data.hourly.temperature_2m[idx]);
                        const code = data.hourly.weather_code[idx];
                        const icon = weatherCodes[code] || 'â“';
                        
                        // æå–å°æ—¶ (HH:00)
                        const timeParts = timeStr.split('T');
                        const timeDisplay = timeParts.length > 1 ? timeParts[1] : timeStr;

                        const el = document.createElement('div');
                        el.className = 'forecast-item';
                        el.innerHTML = `
                            <div class="forecast-time">${timeDisplay}</div>
                            <div class="forecast-icon">${icon}</div>
                            <div class="forecast-temp">${temp}Â°</div>
                        `;
                        forecastContainer.appendChild(el);
                    }
                });
            }

        } catch (e) { console.error("å¤©æ°”é”™è¯¯", e); }
    }
    updateWeather();
    setInterval(updateWeather, 1800000); // 30åˆ†é’Ÿåˆ·æ–°

    // ==================== 3. é‡‘èé€»è¾‘ ====================
    let chartInstances = {}; // å­˜å‚¨ chart å®ä¾‹
    let watchlist = [];
    let currentStockIndex = 0;
    // ä»åç«¯é…ç½®è¯»å– (é»˜è®¤ 30s å’Œ 10s)
    const tickerSpeed = {{ finance_config.get('ticker_speed_seconds', 30) }};
    const stockSwitchInterval = {{ finance_config.get('stock_switch_interval_seconds', 10) }} * 1000;

    // è·å–æŒ‡æ•°å¹¶åˆ›å»ºè·‘é©¬ç¯
    async function updateIndices() {
        if (window.isAppSleeping) return;
        try {
            const res = await fetch(`${API_BASE}/finance/indices`);
            const data = await res.json();
            const container = document.getElementById('indices-container');
            container.innerHTML = '';
            
            if (data.length === 0) {
                container.innerHTML = '<div style="color:#999; padding:10px;">æš‚æ— æŒ‡æ•°æ•°æ®</div>';
                return;
            }

            const track = document.createElement('div');
            track.className = 'indices-track';
            
            const createCardsHtml = (items) => {
                return items.map(idx => {
                    const isUp = idx.change >= 0;
                    const colorClass = isUp ? 'up' : 'down';
                    const sign = isUp ? '+' : '';
                    return `
                        <div class="index-card">
                            <div class="index-name">${idx.name}</div>
                            <div class="index-price ${colorClass}">${idx.price.toFixed(2)}</div>
                            <div class="index-change ${colorClass}">${sign}${idx.change_percent.toFixed(2)}%</div>
                        </div>
                    `;
                }).join('');
            };

            track.innerHTML = createCardsHtml(data) + createCardsHtml(data);
            container.appendChild(track);
            
            // ä½¿ç”¨é…ç½®çš„å›ºå®šé€Ÿåº¦ (CSS animation duration)
            // å¦‚æœç”¨æˆ·å¸Œæœ›æ˜¯"æ’å®šç‰©ç†é€Ÿåº¦" (px/s)ï¼Œå¯ä»¥ä½¿ç”¨ totalWidth è®¡ç®—
            // è¿™é‡Œæ ¹æ®éœ€æ±‚ç†è§£ä¸º "è½®æ’­ä¸€åœˆçš„æ—¶é—´"ï¼Œæˆ–è€…æˆ‘ä»¬ä¹Ÿå¯ä»¥ç»“åˆå®½åº¦è®¡ç®—
            // æ—¢ç„¶é…ç½®é¡¹å« ticker_speed_secondsï¼Œé€šå¸¸ç†è§£ä¸ºåŠ¨ç”»å‘¨æœŸæˆ–åŸºå‡†é€Ÿåº¦
            
            // æ–¹æ¡ˆA: ç›´æ¥ä½¿ç”¨é…ç½®ä½œä¸ºå‘¨æœŸ (é€‚åˆå†…å®¹é•¿åº¦å›ºå®šçš„æƒ…å†µ)
            // track.style.animationDuration = `${tickerSpeed}s`;

            // æ–¹æ¡ˆB: å°†é…ç½®è§†ä¸ºåŸºå‡†ï¼ˆæ¯”å¦‚é’ˆå¯¹æ ‡å‡†å±å¹•å®½åº¦çš„è€—æ—¶ï¼‰ï¼Œæ ¹æ®å†…å®¹é•¿åº¦ç¼©æ”¾
            // ä¹‹å‰çš„é€»è¾‘: const duration = Math.max(totalWidth / 50, 10);
            // ç°åœ¨çš„éœ€æ±‚: "é€Ÿåº¦...æ”¹æˆå¯é…ç½®çš„"
            // æˆ‘ä»¬ä½¿ç”¨é…ç½®å€¼ä½œä¸ºåŠ¨ç”»å‘¨æœŸï¼Œä½†ä¸ºäº†é˜²æ­¢å†…å®¹è¿‡é•¿å¯¼è‡´æ»šåŠ¨é£å¿«ï¼Œè¿˜æ˜¯è·Ÿå®½åº¦æŒ‚é’©æ¯”è¾ƒåˆç†?
            // ç”¨æˆ·è¯´ "é»˜è®¤ 2ç§’" (å¯¹äºè½®æ’­æ¥è¯´2ç§’å¤ªå¿«äº†ï¼Œåº”è¯¥æ˜¯è¯´ä¸ªè‚¡åˆ‡æ¢ 10ç§’ï¼ŒæŒ‡æ•°è½®æ’­é€Ÿåº¦å¯èƒ½æ˜¯å¦ä¸€ç§ç†è§£)
            // å‡è®¾ç”¨æˆ·æ„æ€æ˜¯ "åŠ¨ç”»æŒç»­æ—¶é—´"ã€‚å¦‚æœé…ç½®æ˜¯ 30ç§’ï¼Œé‚£å°±30ç§’æ»šå®Œä¸€åŠã€‚
            
            track.style.animationDuration = `${tickerSpeed}s`;

        } catch (e) { console.error("æŒ‡æ•°æ›´æ–°å¤±è´¥", e); }
    }

    async function loadWatchlist() {
        if (window.isAppSleeping) return;
        try {
            const res = await fetch(`${API_BASE}/finance/watchlist`);
            watchlist = await res.json();
            if (watchlist.length > 0) {
                loadNextStock();
                setInterval(loadNextStock, stockSwitchInterval); 
            } else {
                document.getElementById('stock-name').textContent = "æ— è‡ªé€‰è‚¡";
            }
        } catch (e) { console.error("è‡ªé€‰è‚¡åˆ—è¡¨å¤±è´¥", e); }
    }

    async function loadNextStock() {
        if (window.isAppSleeping) return;
        if (watchlist.length === 0) return;
        
        const stock = watchlist[currentStockIndex];
        currentStockIndex = (currentStockIndex + 1) % watchlist.length;
        
        try {
            const res = await fetch(`${API_BASE}/finance/stock/${stock.symbol}?name=${encodeURIComponent(stock.name)}`);
            const data = await res.json();
            
            const isUp = data.change >= 0;
            const color = isUp ? '#e74c3c' : '#2ecc71';
            const sign = isUp ? '+' : '';
            
            document.getElementById('stock-name').textContent = data.name;
            document.getElementById('stock-price').textContent = data.price.toFixed(2);
            document.getElementById('stock-price').style.color = color;
            document.getElementById('stock-change').textContent = `${sign}${data.change.toFixed(2)} (${sign}${data.change_percent.toFixed(2)}%)`;
            document.getElementById('stock-change').style.color = color;
            
            // æ¸²æŸ“ä¸¤ä¸ªå›¾è¡¨
            renderChart('stockChart1d', data.history_1d, color, '1d');
            renderChart('stockChart1y', data.history_1y, color, '1y');
            
        } catch (e) { console.error(`ä¸ªè‚¡ ${stock.name} åŠ è½½å¤±è´¥`, e); }
    }

    function renderChart(canvasId, points, lineColor, type) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        
        // é”€æ¯æ—§å®ä¾‹
        if (chartInstances[canvasId]) {
            chartInstances[canvasId].destroy();
        }

        if (!points || points.length === 0) {
            // å¯ä»¥ç»˜åˆ¶ä¸€ä¸ªâ€œæ— æ•°æ®â€çš„æç¤ºï¼Œæˆ–è€…ä¿æŒç©ºç™½
            return;
        }
        
        const labels = points.map(p => p.t);
        const data = points.map(p => p.v);

        const gradient = ctx.createLinearGradient(0, 0, 0, 200);
        gradient.addColorStop(0, lineColor.replace('rgb', 'rgba').replace(')', ', 0.2)')); // é™ä½é€æ˜åº¦
        gradient.addColorStop(1, 'rgba(0,0,0,0)');

        // æ ¹æ®ç±»å‹è°ƒæ•´é…ç½®
        const isIntraday = type === '1d';

        chartInstances[canvasId] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    borderColor: lineColor,
                    backgroundColor: gradient,
                    borderWidth: 1.5,
                    pointRadius: 0,
                    pointHoverRadius: 3,
                    fill: true,
                    tension: 0.2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                    }
                },
                scales: {
                    x: { 
                        display: true, // æ˜¾ç¤ºXè½´
                        ticks: { 
                            color: '#555', 
                            font: {size: 9},
                            maxTicksLimit: 6, // é™åˆ¶æ ‡ç­¾æ•°é‡
                            maxRotation: 0
                        },
                        grid: { display: false }
                    },
                    y: { 
                        display: true,
                        position: 'right',
                        grid: { color: 'rgba(255,255,255,0.05)' },
                        ticks: { color: '#555', font: {size: 9} }
                    }
                },
                animation: { duration: 0 } // ç¦ç”¨åŠ¨ç”»ä»¥æé«˜åˆ‡æ¢é€Ÿåº¦
            }
        });
    }

    // åˆå§‹åŒ–
    updateIndices();
    setInterval(updateIndices, 60000); 
    loadWatchlist();

    // ==================== 4. åŸæœ‰é€»è¾‘ (YouTube + Photos) ====================
    let currentChannel = '{{ default_channel|default("NASA TV") }}';
    let photos = [];
    let currentPhotoIndex = 0;
    let slideshowInterval = null;
    const slideshowDelay = ({{ slideshow_interval_seconds|default(10) }}) * 1000;
    const showMetadata = {{ 'true' if show_metadata else 'false' }};
    const slideshowTransition = '{{ slideshow_transition|default("fade") }}';

    async function loadYouTubeChannel(channelName) {
        try {
            const encoded = encodeURIComponent(channelName);
            const res = await fetch(`${API_BASE}/youtube/embed/${encoded}`);
            const data = await res.json();
            const iframe = document.getElementById('youtube-iframe');
            if (iframe && data.embed_url) {
                const urlObj = new URL(data.embed_url);
                urlObj.searchParams.set('autoplay', '1');
                urlObj.searchParams.set('mute', '0');
                urlObj.searchParams.delete('enablejsapi');
                iframe.src = urlObj.toString();
                iframe.style.display = 'block';
                document.getElementById('youtube-loading').style.display = 'none';
            }
        } catch(e) {}
    }

    async function loadPhotos() {
        try {
            const res = await fetch(`${API_BASE}/albums/slideshow`);
            photos = await res.json();
            
            const container = document.getElementById('photo-container');
            if (photos.length > 0) { 
                // åˆå§‹åŒ–å®¹å™¨ç»“æ„
                container.innerHTML = `
                    <div id="photo-stage" style="width:100%;height:100%;position:relative;" class="transition-${slideshowTransition}"></div>
                    <button class="photo-nav prev" onclick="prevPhoto()">â€¹</button>
                    <button class="photo-nav next" onclick="nextPhoto()">â€º</button>
                    <div id="photo-metadata-container" class="photo-metadata ${showMetadata ? '' : 'hidden'}"></div>
                `;
                
                displayPhoto(0); 
                startSlideshow(); 
            }
            else { 
                container.innerHTML = '<div class="error">æš‚æ— ç…§ç‰‡<br>è¯·åœ¨â€œè®¾ç½®â€ä¸­åˆ›å»ºç›¸å†Œå¹¶ä¸Šä¼ ç…§ç‰‡</div>'; 
            }
        } catch(e) { console.error("åŠ è½½ç…§ç‰‡å¤±è´¥", e); }
    }

    function displayPhoto(index) {
        if (photos.length === 0) return;
        currentPhotoIndex = index;
        const photo = photos[index];
        const stage = document.getElementById('photo-stage');
        if (!stage) return; // Safety check
        
        // åˆ›å»ºæ–°çš„ wrapper
        const wrapper = document.createElement('div');
        wrapper.className = 'photo-wrapper enter'; // åˆå§‹çŠ¶æ€
        
        let contentHtml = '';
        // æ£€æŸ¥æ˜¯å¦ä¸ºè§†é¢‘
        if (photo.type === 'video' || (photo.filename && photo.filename.match(/\.(mp4|mov)$/i))) {
             contentHtml = `<video src="${photo.url}" class="photo-video" autoplay muted loop playsinline style="max-width:100%;max-height:100%;"></video>`;
        } else {
             contentHtml = `<img src="${photo.url}" class="photo-image" loading="eager">`;
        }
        wrapper.innerHTML = contentHtml;
        
        stage.appendChild(wrapper);
        
        // å¼ºåˆ¶é‡ç»˜ä»¥è§¦å‘ transition
        wrapper.offsetHeight; 
        
        // å¤„ç†æ—§çš„ active å…ƒç´ 
        const oldActive = stage.querySelector('.photo-wrapper.active');
        if (oldActive) {
            oldActive.classList.remove('active');
            oldActive.classList.add('exit');
            // åŠ¨ç”»ç»“æŸåç§»é™¤
            setTimeout(() => {
                if(oldActive.parentNode === stage) stage.removeChild(oldActive);
            }, 1000); // åŒ¹é… CSS duration
        }
        
        // æ¿€æ´»æ–°å…ƒç´ 
        wrapper.classList.remove('enter');
        wrapper.classList.add('active');
        
        // æ›´æ–°å…ƒæ•°æ®
        updateMetadata(photo, index);
    }
    
    function updateMetadata(photo, index) {
        const metaContainer = document.getElementById('photo-metadata-container');
        if (!metaContainer) return;
        
        if (!showMetadata) {
            metaContainer.classList.add('hidden');
            return;
        }
        
        let primaryText = '';
        let secondaryHtml = '';
        
        // 1. ä¸»æ ‡é¢˜é€»è¾‘ï¼šä¼˜å…ˆæ˜¾ç¤º ç›¸å†Œåç§°ï¼Œå¦‚æœæ²¡æœ‰ç›¸å†Œååˆ™å°è¯•ç”¨ä½ç½®åï¼Œæœ€åæ˜¯ "æœªå‘½åç›¸å†Œ"
        // ç”¨æˆ·éœ€æ±‚ï¼šç¾åŒ–å¸ƒå±€ï¼Œä¸è¦çªå…€ã€‚
        // ç°åœ¨çš„è®¾è®¡ï¼š
        // ä¸»è¡Œ (å¤§å­—): ç›¸å†Œåç§° (å¦‚ "å¦‚æ„å¹³å®‰çš„å®¶åº­ç›¸å†Œ")
        // å‰¯è¡Œ (å°å­—): æ—¶é—´ | è®¾å¤‡ | åœ°ç‚¹
        
        primaryText = photo.album_name || 'æœªå‘½åç›¸å†Œ';
        
        // 2. å‰¯ä¿¡æ¯é€»è¾‘
        
        // æ—¶é—´
        let timeStr = '';
        if (photo.date_taken) {
            // æ ¼å¼åŒ–: 2025-11-15 12:45
            try {
                const d = new Date(photo.date_taken.replace(' ', 'T'));
                const datePart = d.toLocaleDateString('zh-CN', {year: 'numeric', month: '2-digit', day: '2-digit'}).replace(/\//g, '-');
                const timePart = d.toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit', hour12: false});
                timeStr = `${datePart} ${timePart}`;
            } catch(e) { timeStr = photo.date_taken; }
        } else if (photo.created_at) {
            try { 
                 const d = new Date(photo.created_at);
                 timeStr = d.toLocaleDateString('zh-CN').replace(/\//g, '-');
            } catch(e) {}
        }
        if (timeStr) {
             secondaryHtml += `<div class="meta-item"><span class="meta-icon">ğŸ“…</span> ${timeStr}</div>`;
        }
        
        // è®¾å¤‡
        if (photo.model) {
            const make = photo.make ? photo.make.replace(/\0/g, '') : '';
            const model = photo.model.replace(/\0/g, '');
            let device = model;
            // ç®€å•å»é‡é€»è¾‘
            if (make && !model.toLowerCase().includes(make.toLowerCase())) {
                device = `${make} ${model}`;
            }
            secondaryHtml += `<div class="meta-item"><span class="meta-icon">ğŸ“·</span> ${device}</div>`;
        }
        
        // åœ°ç‚¹ (ä¼˜å…ˆæ˜¾ç¤ºè§£æåçš„ location_nameï¼Œå¦‚æœæ²¡æœ‰ä½†æœ‰åæ ‡æ˜¾ç¤º "åŒ…å«åœ°ç†ä½ç½®")
        if (photo.location_name) {
             secondaryHtml += `<div class="meta-item"><span class="meta-icon">ğŸ“</span> ${photo.location_name}</div>`;
        } else if (photo.has_location) {
             secondaryHtml += `<div class="meta-item"><span class="meta-icon">ğŸ“</span> ${photo.location && photo.location.lat ? 'æœªçŸ¥åœ°ç‚¹' : 'åŒ…å«ä½ç½®ä¿¡æ¯'}</div>`;
        }

        const html = `
            <div class="meta-primary">
                <span class="meta-icon">ğŸ“</span> ${primaryText}
            </div>
            <div class="meta-secondary">
                ${secondaryHtml}
            </div>
            <div class="meta-counter">${index + 1} / ${photos.length}</div>
        `;
        
        metaContainer.innerHTML = html;
    }
    
    function prevPhoto() {
        if (photos.length === 0) return;
        currentPhotoIndex = (currentPhotoIndex - 1 + photos.length) % photos.length;
        displayPhoto(currentPhotoIndex);
        resetSlideshow();
    }
    
    function nextPhoto() {
        if (photos.length === 0) return;
        currentPhotoIndex = (currentPhotoIndex + 1) % photos.length;
        displayPhoto(currentPhotoIndex);
        resetSlideshow();
    }
    
    function startSlideshow() {
        if (slideshowInterval) clearInterval(slideshowInterval);
        slideshowInterval = setInterval(() => {
             nextPhoto();
        }, slideshowDelay);
    }
    
    function resetSlideshow() {
        if (slideshowInterval) clearInterval(slideshowInterval);
        startSlideshow();
    }

    document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft') { prevPhoto(); }
        else if (e.key === 'ArrowRight') { nextPhoto(); }
        else if (e.key === 'Escape') {
            if (document.fullscreenElement) document.exitFullscreen();
        }
    });

    window.addEventListener('DOMContentLoaded', () => {
        if (currentChannel) loadYouTubeChannel(currentChannel);
        loadPhotos();
        initSleepManager(); // å§‹ç»ˆåˆå§‹åŒ–ï¼Œç”±å†…éƒ¨é€»è¾‘å†³å®šæ˜¯å¦å¯ç”¨
    });
    
    // ==================== 5. èŠ‚èƒ½ä¼‘çœ é€»è¾‘ ====================
    function initSleepManager() {
        // çŠ¶æ€å˜é‡ (åˆå§‹åŒ–ä½¿ç”¨æ¨¡æ¿å€¼ä½œä¸ºé»˜è®¤ï¼Œåç»­é€šè¿‡ API æ›´æ–°)
        let configEnabled = {{ 'true' if energy_config.get('enabled', True) else 'false' }};
        let configStartTime = "{{ energy_config.get('start_time', '22:30') }}";
        let configEndTime = "{{ energy_config.get('end_time', '05:30') }}";

        let isSleeping = false;
        let sleepInterval = null;
        let pixelShiftInterval = null;
        let configPollInterval = null;

        // è§£ææ—¶é—´ "HH:MM" -> åˆ†é’Ÿæ•°
        const parseTime = (t) => {
            if (!t) return 0;
            const [h, m] = t.split(':').map(Number);
            return h * 60 + m;
        };

        // åŒæ­¥æœ€æ–°é…ç½®
        const syncConfig = async () => {
            try {
                const res = await fetch(`${API_BASE}/settings/`);
                if (!res.ok) return;
                const data = await res.json();
                
                // æ›´æ–°æœ¬åœ°é…ç½®å˜é‡
                configEnabled = data.energy_enabled;
                configStartTime = data.energy_start_time;
                configEndTime = data.energy_end_time;
                
                // ç«‹å³æ£€æŸ¥çŠ¶æ€ (å“åº”ä¿®æ”¹)
                checkSleep();
            } catch (e) {
                console.error("é…ç½®åŒæ­¥å¤±è´¥ (éè‡´å‘½)", e);
            }
        };

        const checkSleep = () => {
            // å¦‚æœåŠŸèƒ½æœªå¯ç”¨ï¼Œç¡®ä¿ä¸åœ¨ä¼‘çœ çŠ¶æ€
            if (!configEnabled) {
                if (isSleeping) exitSleep();
                return;
            }

            const now = new Date();
            const currMins = now.getHours() * 60 + now.getMinutes();
            const startMins = parseTime(configStartTime);
            const endMins = parseTime(configEndTime);
            
            let shouldSleep = false;
            // ä¿®å¤é€»è¾‘: å¤„ç† start > end (è·¨å¤©) å’Œ start < end (å½“å¤©)
            if (startMins > endMins) {
                // è·¨å¤©æƒ…å†µ (e.g. 22:30 to 05:30)
                // should sleep if time is >= 22:30 OR time < 05:30
                shouldSleep = (currMins >= startMins) || (currMins < endMins);
            } else {
                // å½“å¤©æƒ…å†µ (e.g. 01:00 to 06:00, or 19:30 to 21:30)
                // should sleep if time is >= 19:30 AND time < 21:30
                shouldSleep = (currMins >= startMins) && (currMins < endMins);
            }

            // çŠ¶æ€åˆ‡æ¢
            if (shouldSleep && !isSleeping) {
                enterSleep();
            } else if (!shouldSleep && isSleeping) {
                exitSleep();
            }
            
            if (isSleeping) {
                // å¦‚æœåœ¨ä¼‘çœ ä¸­ï¼Œå¯èƒ½éœ€è¦æ›´æ–°æ—¶é’Ÿ (è™½ç„¶ updateSleepClock æœ‰è‡ªå·±çš„ tickingï¼Œä½†è¿™é‡ŒåŒé‡ä¿é™©)
            }
        };

        const enterSleep = () => {
            console.log("è¿›å…¥ä¼‘çœ æ¨¡å¼");
            isSleeping = true;
            document.getElementById('sleep-overlay').style.display = 'flex';
            
            // 1. é”€æ¯ YouTube (ç§»é™¤ src)
            const iframe = document.getElementById('youtube-iframe');
            if (iframe) iframe.src = '';
            
            // 2. åœæ­¢è½®æ’­
            if (slideshowInterval) clearInterval(slideshowInterval);
            
            // 3. åœæ­¢å…¶ä»–å®šæ—¶å™¨
            window.isAppSleeping = true;

            // 4. å¯åŠ¨åƒç´ åç§»é˜²æ­¢çƒ§å±
            pixelShiftInterval = setInterval(() => {
                const content = document.querySelector('.sleep-content');
                const x = Math.floor(Math.random() * 100) - 50; 
                const y = Math.floor(Math.random() * 100) - 50;
                content.style.transform = `translate(${x}px, ${y}px)`;
            }, 60000 * 5); 
            
            // ç«‹å³æ›´æ–°ä¸€æ¬¡æ—¶é’Ÿ
            updateSleepClock();
        };

        const exitSleep = () => {
            console.log("é€€å‡ºä¼‘çœ æ¨¡å¼");
            isSleeping = false;
            window.isAppSleeping = false;
            document.getElementById('sleep-overlay').style.display = 'none';
            
            // 1. æ¢å¤ YouTube
            if (currentChannel) loadYouTubeChannel(currentChannel);
            
            // 2. æ¢å¤è½®æ’­
            startSlideshow();
            
            // 3. ç«‹å³åˆ·æ–°æ•°æ®
            updateIndices();
            updateWeather();
            
            if (pixelShiftInterval) clearInterval(pixelShiftInterval);
        };

        const updateSleepClock = () => {
            const now = new Date();
            const h = String(now.getHours()).padStart(2, '0');
            const m = String(now.getMinutes()).padStart(2, '0');
            const s = String(now.getSeconds()).padStart(2, '0');
            document.getElementById('sleep-time').textContent = `${h}:${m}:${s}`;
            
            const days = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
            const dateStr = `${now.getFullYear()}å¹´${String(now.getMonth()+1).padStart(2,'0')}æœˆ${String(now.getDate()).padStart(2,'0')}æ—¥ ${days[now.getDay()]}`;
            document.getElementById('sleep-date-full').textContent = dateStr;

            if (window.Lunar) {
                const lunar = Lunar.fromDate(now);
                const lunarStr = `${lunar.getMonthInChinese()}æœˆ${lunar.getDayInChinese()} Â· ${lunar.getYearInGanZhi()}å¹´ [${lunar.getYearShengXiao()}å¹´]`;
                document.getElementById('sleep-lunar').textContent = lunarStr;
            }
        };

        // å®šæ—¶ä»»åŠ¡
        
        // 1. æ—¶é’Ÿæ›´æ–° (æ¯ç§’) - ä»…åœ¨ä¼‘çœ æ—¶æœ‰æ•ˆ
        if (sleepInterval) clearInterval(sleepInterval);
        sleepInterval = setInterval(() => {
            if (isSleeping) updateSleepClock();
        }, 1000);
        
        // 2. çŠ¶æ€æ£€æŸ¥ (æ¯ç§’) - ç¡®ä¿æ—¶é—´ä¸€åˆ°ç«‹å³å“åº”
        setInterval(checkSleep, 1000);
        
        // 3. é…ç½®åŒæ­¥ (æ¯5ç§’) - ç¡®ä¿è®¾ç½®ä¿®æ”¹åæ— éœ€åˆ·æ–°é¡µé¢
        setInterval(syncConfig, 5000);
        
        checkSleep(); // ç«‹å³æ£€æŸ¥ä¸€æ¬¡
    }
</script>
{% endblock %}