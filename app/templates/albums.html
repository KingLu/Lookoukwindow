<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç›¸å†Œç®¡ç† - Lookoukwindow</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: system-ui, -apple-system, sans-serif; background: #1a1a1a; color: #fff; padding-bottom: 80px; }
        
        /* Admin Nav */
        .admin-nav {
            background: #2d2d2d;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            align-items: center;
            border-bottom: 1px solid #333;
        }
        .admin-nav a {
            color: #aaa;
            text-decoration: none;
            font-size: 14px;
            padding: 5px 10px;
            border-radius: 4px;
        }
        .admin-nav a.active { background: #444; color: #fff; }
        .admin-nav a:hover { color: #fff; }
        .back-home { margin-right: auto; color: #667eea !important; font-weight: bold; }

        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn { padding: 8px 16px; border-radius: 4px; border: none; cursor: pointer; font-size: 14px; font-weight: 500; color: #fff; background: #667eea; }
        .btn:hover { background: #5568d3; }
        
        /* Album Grid */
        .album-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .album-card {
            background: #2d2d2d;
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.2s;
            cursor: pointer;
        }
        .album-card:hover { transform: translateY(-3px); background: #333; }
        
        .album-cover {
            height: 160px;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #444;
            font-size: 40px;
        }
        .album-cover img { width: 100%; height: 100%; object-fit: cover; }
        
        .album-info { padding: 15px; }
        .album-name { font-weight: bold; margin-bottom: 5px; font-size: 16px; }
        .album-count { font-size: 12px; color: #888; display: flex; justify-content: space-between; }
        .active-badge { background: #27ae60; color: #fff; padding: 2px 6px; border-radius: 10px; font-size: 10px; }

        /* Detail View (Overlay) */
        .detail-view {
            position: fixed; top: 60px; left: 0; width: 100%; height: calc(100% - 60px);
            background: #1a1a1a;
            z-index: 100;
            display: none;
            flex-direction: column;
        }
        .detail-header {
            padding: 20px;
            background: #252525;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .detail-content { flex: 1; overflow-y: auto; padding: 20px; }
        
        /* Photo Grid within Album */
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
        }
        .photo-item {
            aspect-ratio: 1;
            background: #000;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
        .photo-item img { width: 100%; height: 100%; object-fit: cover; }
        
        /* Picker Modal */
        .picker-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 200;
        }
        .picker-content {
            width: 90%; max-width: 1000px; height: 90vh; margin: 5vh auto;
            background: #2d2d2d; border-radius: 8px; display: flex; flex-direction: column;
        }
        .picker-header { padding: 15px; border-bottom: 1px solid #444; display: flex; justify-content: space-between; }
        .picker-body { flex: 1; overflow-y: auto; padding: 15px; }
        .picker-footer { padding: 15px; border-top: 1px solid #444; display: flex; justify-content: flex-end; gap: 10px; }
        
        .picker-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; }
        .picker-item { aspect-ratio: 1; border-radius: 4px; overflow: hidden; position: relative; cursor: pointer; opacity: 0.6; border: 2px solid transparent; }
        .picker-item.selected { opacity: 1; border-color: #667eea; }
        .picker-item img { width: 100%; height: 100%; object-fit: cover; }
        .check-icon { position: absolute; top: 5px; right: 5px; background: #667eea; color: #fff; border-radius: 50%; width: 20px; height: 20px; display: none; align-items: center; justify-content: center; font-size: 12px; }
        .picker-item.selected .check-icon { display: flex; }

        /* Toggle Switch */
        .switch { position: relative; display: inline-block; width: 34px; height: 18px; vertical-align: middle; margin-left: 10px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #27ae60; }
        input:checked + .slider:before { transform: translateX(16px); }

    </style>
</head>
<body>

    <div class="admin-nav">
        <a href="/" class="back-home">â† è¿”å›å±•ç¤ºå±</a>
        <a href="/settings">ç³»ç»Ÿè®¾ç½®</a>
        <a href="/admin/library">ç…§ç‰‡åº“</a>
        <a href="/admin/albums" class="active">ç›¸å†Œç®¡ç†</a>
    </div>

    <div class="container">
        <div class="header">
            <h2>æˆ‘çš„ç›¸å†Œ</h2>
            <button class="btn" onclick="createAlbum()">+ æ–°å»ºç›¸å†Œ</button>
        </div>
        <div class="album-grid" id="albumList">
            <!-- Albums -->
        </div>
    </div>

    <!-- Detail View -->
    <div id="detailView" class="detail-view">
        <div class="detail-header">
            <div style="display:flex; align-items:center; gap: 15px;">
                <button onclick="closeDetail()" style="background:transparent; border:1px solid #555; color:#fff; padding:5px 10px; cursor:pointer;">â† è¿”å›</button>
                <div>
                    <h2 id="detailTitle">ç›¸å†Œæ ‡é¢˜</h2>
                    <div style="font-size:12px; color:#888; margin-top:2px;">
                        <span id="detailCount">0 å¼ ç…§ç‰‡</span>
                        <label class="switch" title="å¯ç”¨è½®æ’­">
                            <input type="checkbox" id="detailActive" onchange="toggleActive(this.checked)">
                            <span class="slider"></span>
                        </label>
                        <span style="margin-left:5px;">å¯ç”¨å±•ç¤º</span>
                    </div>
                </div>
            </div>
            <div>
                <button class="btn" style="background:#e74c3c; margin-right:10px;" onclick="deleteCurrentAlbum()">åˆ é™¤ç›¸å†Œ</button>
                <button class="btn" onclick="openPicker()">+ æ·»åŠ ç…§ç‰‡</button>
            </div>
        </div>
        <div class="detail-content">
            <div class="photo-grid" id="detailGrid"></div>
        </div>
    </div>

    <!-- Photo Picker -->
    <div id="pickerModal" class="picker-modal">
        <div class="picker-content">
            <div class="picker-header">
                <h3>é€‰æ‹©ç…§ç‰‡æ·»åŠ åˆ°ç›¸å†Œ</h3>
                <button onclick="closePicker()" style="background:none; border:none; color:#aaa; cursor:pointer; font-size:20px;">&times;</button>
            </div>
            <div class="picker-body">
                <div class="picker-grid" id="pickerGrid"></div>
            </div>
            <div class="picker-footer">
                <div style="margin-right: auto; align-self: center; display: flex; align-items: center; gap: 10px;">
                    <span id="selectedCount" style="color: #888;">å·²é€‰: 0</span>
                    <button class="btn" style="background: #444; font-size: 12px; padding: 4px 8px;" onclick="selectAllInPicker()">å…¨é€‰</button>
                </div>
                <button class="btn" style="background:#444;" onclick="closePicker()">å–æ¶ˆ</button>
                <button class="btn" onclick="confirmAdd()">æ·»åŠ é€‰ä¸­</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let currentAlbumId = null;
        let libraryPhotos = [];
        let pickerSelected = new Set();

        document.addEventListener('DOMContentLoaded', loadAlbums);

        async function loadAlbums() {
            const res = await fetch(`${API_BASE}/albums`);
            const albums = await res.json();
            const container = document.getElementById('albumList');
            container.innerHTML = '';
            
            albums.forEach(album => {
                const cover = album.cover_photo 
                    ? `${API_BASE}/library/photos/${album.cover_photo}/thumbnail` 
                    : null;
                
                const el = document.createElement('div');
                el.className = 'album-card';
                el.innerHTML = `
                    <div class="album-cover">
                        ${cover ? `<img src="${cover}" loading="lazy">` : 'ğŸ“'}
                    </div>
                    <div class="album-info">
                        <div class="album-name">${album.name}</div>
                        <div class="album-count">
                            <span>${album.photo_count} å¼ </span>
                            ${album.active ? '<span class="active-badge">å±•ç¤ºä¸­</span>' : ''}
                        </div>
                    </div>
                `;
                el.onclick = () => openDetail(album);
                container.appendChild(el);
            });
        }

        async function createAlbum() {
            const name = prompt("è¯·è¾“å…¥ç›¸å†Œåç§°:");
            if (name) {
                const formData = new FormData();
                formData.append('name', name);
                await fetch(`${API_BASE}/albums`, { method: 'POST', body: formData });
                loadAlbums();
            }
        }

        // --- Detail View ---

        async function openDetail(album) {
            currentAlbumId = album.id;
            document.getElementById('detailTitle').textContent = album.name;
            document.getElementById('detailActive').checked = album.active;
            document.getElementById('detailView').style.display = 'flex';
            loadAlbumPhotos();
        }

        function closeDetail() {
            document.getElementById('detailView').style.display = 'none';
            currentAlbumId = null;
            loadAlbums(); // Refresh list
        }

        async function loadAlbumPhotos() {
            const res = await fetch(`${API_BASE}/albums/${currentAlbumId}/photos`);
            const photos = await res.json();
            document.getElementById('detailCount').textContent = `${photos.length} å¼ ç…§ç‰‡`;
            
            const grid = document.getElementById('detailGrid');
            grid.innerHTML = '';
            
            photos.forEach(p => {
                const url = p.thumbnail_url || p.url;
                const el = document.createElement('div');
                el.className = 'photo-item';
                el.innerHTML = `
                    <img src="${url}" loading="lazy">
                    <button style="position:absolute; top:5px; right:5px; background:rgba(0,0,0,0.6); color:#fff; border:none; border-radius:50%; width:24px; height:24px; cursor:pointer;" onclick="removeFromAlbum('${p.id}')">&times;</button>
                `;
                grid.appendChild(el);
            });
        }

        async function toggleActive(isActive) {
            const formData = new FormData();
            formData.append('active', isActive);
            await fetch(`${API_BASE}/albums/${currentAlbumId}`, { method: 'PUT', body: formData });
        }

        async function deleteCurrentAlbum() {
            if (!confirm("ç¡®å®šè¦åˆ é™¤æ­¤ç›¸å†Œå—ï¼Ÿ(ç…§ç‰‡ä¸ä¼šè¢«åˆ é™¤)")) return;
            await fetch(`${API_BASE}/albums/${currentAlbumId}`, { method: 'DELETE' });
            closeDetail();
        }

        async function removeFromAlbum(photoId) {
            if(!confirm("ä»ç›¸å†Œä¸­ç§»é™¤ï¼Ÿ")) return;
            await fetch(`${API_BASE}/albums/${currentAlbumId}/photos/remove`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({photo_ids: [photoId]})
            });
            loadAlbumPhotos();
        }

        // --- Picker Logic ---

        async function openPicker() {
            document.getElementById('pickerModal').style.display = 'block';
            // Load library photos
            if (libraryPhotos.length === 0) {
                const res = await fetch(`${API_BASE}/library/photos`);
                libraryPhotos = await res.json();
            }
            pickerSelected.clear();
            renderPicker();
        }

        function closePicker() {
            document.getElementById('pickerModal').style.display = 'none';
        }

        function renderPicker() {
            const grid = document.getElementById('pickerGrid');
            grid.innerHTML = '';
            document.getElementById('selectedCount').textContent = `å·²é€‰: ${pickerSelected.size}`;
            
            libraryPhotos.forEach(p => {
                const el = document.createElement('div');
                el.className = `picker-item ${pickerSelected.has(p.id) ? 'selected' : ''}`;
                el.dataset.id = p.id; // Store ID for bulk selection
                const url = p.thumbnail_url || p.url;
                el.innerHTML = `
                    <img src="${url}" loading="lazy">
                    <div class="check-icon">âœ“</div>
                `;
                el.onclick = () => {
                    if (pickerSelected.has(p.id)) pickerSelected.delete(p.id);
                    else pickerSelected.add(p.id);
                    el.classList.toggle('selected');
                    document.getElementById('selectedCount').textContent = `å·²é€‰: ${pickerSelected.size}`;
                };
                grid.appendChild(el);
            });
        }

        function selectAllInPicker() {
            const allSelected = libraryPhotos.length > 0 && pickerSelected.size === libraryPhotos.length;
            
            if (allSelected) {
                pickerSelected.clear();
            } else {
                libraryPhotos.forEach(p => pickerSelected.add(p.id));
            }
            renderPicker();
        }

        async function confirmAdd() {
            if (pickerSelected.size === 0) return;
            const ids = Array.from(pickerSelected);
            
            await fetch(`${API_BASE}/albums/${currentAlbumId}/photos/add`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({photo_ids: ids})
            });
            
            closePicker();
            loadAlbumPhotos();
        }
    </script>
</body>
</html>
