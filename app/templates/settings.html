<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>设置 - Lookoukwindow</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, -apple-system, sans-serif; background: #1a1a1a; color: #fff; padding-bottom: 80px; }
        
        /* Admin Nav */
        .admin-nav {
            background: #2d2d2d;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            align-items: center;
            border-bottom: 1px solid #333;
        }
        .admin-nav a {
            color: #aaa;
            text-decoration: none;
            font-size: 14px;
            padding: 5px 10px;
            border-radius: 4px;
        }
        .admin-nav a.active { background: #444; color: #fff; }
        .admin-nav a:hover { color: #fff; }
        .back-home { margin-right: auto; color: #667eea !important; font-weight: bold; }

        .container { max-width: 900px; margin: 0 auto; padding: 0 20px; }
        
        h1 { margin-bottom: 30px; }
        
        .section {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .section h2 {
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 10px;
        }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: #ccc; }
        
        select, input[type="text"], input[type="number"], input[type="time"], textarea {
            width: 100%;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            color: #fff;
            font-size: 14px;
        }
        
        button {
            background: #667eea; color: white; border: none; padding: 8px 16px; border-radius: 4px;
            cursor: pointer; font-size: 14px; margin-right: 10px; transition: background 0.2s;
        }
        button:hover { background: #5568d3; }
        
        button.danger { background: #e74c3c; }
        button.danger:hover { background: #c0392b; }
        
        button.primary-btn {
            background: #27ae60; font-weight: bold; padding: 10px 20px; font-size: 16px;
        }
        button.primary-btn:hover { background: #219150; }
        
        .status {
            margin-top: 0; padding: 10px; border-radius: 4px; display: none; margin-right: 10px;
        }
        .status.success { background: rgba(39, 174, 96, 0.2); color: #27ae60; display: inline-block; }
        .status.error { background: rgba(231, 76, 60, 0.2); color: #e74c3c; display: inline-block; }

        /* Bottom Sticky Bar */
        .bottom-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: rgba(26, 26, 26, 0.95); border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px 0; backdrop-filter: blur(10px); z-index: 1000;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
        }
        .bottom-bar-content {
            max-width: 900px; margin: 0 auto; padding: 0 20px;
            display: flex; justify-content: flex-end; align-items: center;
        }

        /* Toggle Switch */
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #27ae60; }
        input:checked + .slider:before { transform: translateX(20px); }
    </style>
</head>
<body>

    <div class="admin-nav">
        <a href="/" class="back-home">← 返回展示屏</a>
        <a href="/settings" class="active">系统设置</a>
        <a href="/admin/library">照片库</a>
        <a href="/admin/albums">相册管理</a>
    </div>

    <div class="container">
        <h1>系统设置</h1>
        
        <!-- Main Settings Form Container -->
        <div id="mainSettings">
            <div class="section">
                <h2>显示设置</h2>
                <div class="form-group">
                    <label>布局模式</label>
                    <select id="layout">
                        <option value="side-by-side">并排显示 (默认)</option>
                        <option value="stacked">上下堆叠</option>
                        <option value="picture-in-picture">画中画模式</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>轮播间隔（秒）</label>
                    <input type="number" id="slideshowInterval" min="1" max="3600" value="10">
                </div>
                <div class="form-group">
                    <label>播放顺序</label>
                    <select id="slideshowOrder">
                        <option value="shuffle">随机播放 (默认)</option>
                        <option value="sequential">顺序播放</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>切换效果</label>
                    <select id="slideshowTransition">
                        <option value="fade">淡入淡出 (默认)</option>
                        <option value="none">直接切换</option>
                        <option value="slide-left">向左滑动</option>
                        <option value="slide-right">向右滑动</option>
                        <option value="slide-up">向上滑动</option>
                        <option value="slide-down">向下滑动</option>
                        <option value="zoom-in">渐大 (Zoom In)</option>
                        <option value="zoom-out">渐小 (Zoom Out)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="showMetadata"> 显示照片信息（文件名/时间）
                    </label>
                </div>
                <div class="form-group">
                    <label>屏幕旋转</label>
                    <select id="screenRotation">
                        <option value="normal">正常 (0°)</option>
                        <option value="left">左转 (90°)</option>
                        <option value="right">右转 (90°)</option>
                        <option value="inverted">倒置 (180°)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>时间格式</label>
                    <select id="timeFormat">
                        <option value="24h">24小时制 (14:30)</option>
                        <option value="12h">12小时制 (02:30 PM)</option>
                    </select>
                </div>
            </div>

            <div class="section">
                <h2>天气设置</h2>
                <div class="form-group">
                    <label>显示地名</label>
                    <input type="text" id="weatherLocationName" placeholder="例如：北京市大兴区">
                </div>
                <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label>纬度 (Latitude)</label>
                        <input type="number" id="weatherLatitude" step="0.01" placeholder="例如：39.73">
                    </div>
                    <div>
                        <label>经度 (Longitude)</label>
                        <input type="number" id="weatherLongitude" step="0.01" placeholder="例如：116.33">
                    </div>
                </div>
                <p style="font-size: 12px; color: #999; margin-bottom: 10px;">
                    提示：您可以在 Google Maps 上右键点击位置获取经纬度。
                </p>
            </div>
            
            <div class="section">
                <h2>节能模式设置</h2>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <div class="switch">
                            <input type="checkbox" id="energyEnabled">
                            <span class="slider"></span>
                        </div>
                        <span>启用夜间休眠模式 (黑屏时钟，停止直播和数据更新)</span>
                    </label>
                </div>
                <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label>休眠开始时间</label>
                        <input type="time" id="energyStartTime">
                    </div>
                    <div>
                        <label>休眠结束时间</label>
                        <input type="time" id="energyEndTime">
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>金融数据设置</h2>
                <div class="form-group">
                    <label>指数列表 (Symbol, Name)</label>
                    <div style="font-size:12px;color:#999;margin-bottom:5px;">每行一个，格式：代码,名称 (例如: ^IXIC,纳斯达克)</div>
                    <textarea id="financeIndices" rows="6" style="font-family:monospace;"></textarea>
                </div>
                <div class="form-group">
                    <label>自选股列表 (Symbol, Name)</label>
                    <div style="font-size:12px;color:#999;margin-bottom:5px;">每行一个，格式：代码,名称 (例如: AAPL,苹果)</div>
                    <textarea id="financeStocks" rows="6" style="font-family:monospace;"></textarea>
                </div>
                <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label>指数跑马灯速度 (秒)</label>
                        <div style="font-size:12px;color:#999;margin-bottom:5px;">数值越大滚动越慢 (推荐: 30)</div>
                        <input type="number" id="financeTickerSpeed" min="5" max="300" value="30">
                    </div>
                    <div>
                        <label>个股切换间隔 (秒)</label>
                        <div style="font-size:12px;color:#999;margin-bottom:5px;">推荐: 10</div>
                        <input type="number" id="financeStockSwitchInterval" min="3" max="300" value="10">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h2>YouTube 频道配置</h2>
            <div id="channelsList" style="margin-bottom: 15px;"></div>
            <button onclick="addChannel()">+ 添加直播频道</button>
        </div>
    </div>

    <!-- Sticky Bottom Bar -->
    <div class="bottom-bar">
        <div class="bottom-bar-content">
            <div id="status" class="status"></div>
            <button onclick="saveSettings()" class="primary-btn">保存所有设置</button>
        </div>
    </div>

    <script>
        const API_BASE = '/api';

        // 初始化
        window.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            loadChannels();
        });

        // --- Existing Settings Logic (Youtube/UI) ---
        
        async function loadSettings() {
            try {
                const response = await fetch(`${API_BASE}/settings/`);
                const data = await response.json();
                
                document.getElementById('layout').value = data.layout || 'side-by-side';
                document.getElementById('slideshowInterval').value = data.slideshow_interval_seconds || 10;
                document.getElementById('slideshowOrder').value = data.slideshow_order || 'shuffle';
                document.getElementById('slideshowTransition').value = data.slideshow_transition || 'fade';
                document.getElementById('showMetadata').checked = data.show_metadata !== false;
                document.getElementById('screenRotation').value = data.screen_rotation || 'normal';
                document.getElementById('timeFormat').value = data.time_format || '24h';
                document.getElementById('weatherLocationName').value = data.weather_location_name || '北京市大兴区';
                document.getElementById('weatherLatitude').value = data.weather_latitude || 39.73;
                document.getElementById('weatherLongitude').value = data.weather_longitude || 116.33;
                
                // Load finance settings (convert array to CSV-like string)
                const indices = data.finance_indices || [];
                document.getElementById('financeIndices').value = indices.map(i => `${i.symbol},${i.name}`).join('\n');
                
                const stocks = data.finance_stocks || [];
                document.getElementById('financeStocks').value = stocks.map(s => `${s.symbol},${s.name}`).join('\n');

                document.getElementById('financeTickerSpeed').value = data.finance_ticker_speed_seconds || 30;
                document.getElementById('financeStockSwitchInterval').value = data.finance_stock_switch_interval_seconds || 10;

                // Energy
                document.getElementById('energyEnabled').checked = data.energy_enabled !== false;
                document.getElementById('energyStartTime').value = data.energy_start_time || '22:30';
                document.getElementById('energyEndTime').value = data.energy_end_time || '05:30';

            } catch (error) {
                console.error('加载设置失败:', error);
            }
        }

        async function saveSettings() {
            // Helper to parse textarea to array of objects
            const parseFinanceConfig = (text) => {
                return text.split('\n')
                    .map(line => line.trim())
                    .filter(line => line && line.includes(','))
                    .map(line => {
                        const [symbol, ...nameParts] = line.split(',');
                        return { symbol: symbol.trim(), name: nameParts.join(',').trim() };
                    });
            };

            const settings = {
                layout: document.getElementById('layout').value,
                slideshow_interval_seconds: parseInt(document.getElementById('slideshowInterval').value),
                slideshow_order: document.getElementById('slideshowOrder').value,
                slideshow_transition: document.getElementById('slideshowTransition').value,
                show_metadata: document.getElementById('showMetadata').checked,
                screen_rotation: document.getElementById('screenRotation').value,
                time_format: document.getElementById('timeFormat').value,
                weather_location_name: document.getElementById('weatherLocationName').value,
                weather_latitude: parseFloat(document.getElementById('weatherLatitude').value),
                weather_longitude: parseFloat(document.getElementById('weatherLongitude').value),
                finance_indices: parseFinanceConfig(document.getElementById('financeIndices').value),
                finance_stocks: parseFinanceConfig(document.getElementById('financeStocks').value),
                finance_ticker_speed_seconds: parseInt(document.getElementById('financeTickerSpeed').value),
                finance_stock_switch_interval_seconds: parseInt(document.getElementById('financeStockSwitchInterval').value),
                energy_enabled: document.getElementById('energyEnabled').checked,
                energy_start_time: document.getElementById('energyStartTime').value,
                energy_end_time: document.getElementById('energyEndTime').value
            };
            
            try {
                await fetch(`${API_BASE}/settings/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
                showStatus('设置保存成功', 'success');
            } catch (error) {
                showStatus('保存失败', 'error');
            }
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            setTimeout(() => {
                statusDiv.className = 'status';
            }, 3000);
        }

        async function loadChannels() {
            try {
                const response = await fetch(`${API_BASE}/youtube/channels`);
                const data = await response.json();
                const channelsList = document.getElementById('channelsList');
                channelsList.innerHTML = '';
                
                data.channels.forEach(channel => {
                    const div = document.createElement('div');
                    div.style.marginBottom = '10px';
                    div.style.background = 'rgba(255,255,255,0.1)';
                    div.style.padding = '8px';
                    div.style.borderRadius = '4px';
                    div.style.display = 'flex';
                    div.style.justifyContent = 'space-between';
                    div.style.alignItems = 'center';
                    
                    div.innerHTML = `
                        <span>${channel.name}</span>
                        ${channel.name !== 'NASA TV' && channel.name !== 'ISS Live' && channel.name !== 'NASA Live' ? 
                            `<button onclick="deleteChannel('${channel.name}')" style="background:#e74c3c;margin:0;padding:4px 8px;">删除</button>` : 
                            '<span style="font-size:12px;color:#999">预设</span>'}
                    `;
                    channelsList.appendChild(div);
                });
            } catch (error) {
                console.error('加载频道失败:', error);
            }
        }

        function addChannel() {
            const name = prompt('请输入频道名称:');
            if (!name) return;
            const url = prompt('请输入 YouTube URL:');
            if (!url) return;
            
            fetch(`${API_BASE}/youtube/channels`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, url })
            }).then(loadChannels);
        }

        function deleteChannel(name) {
            if (!confirm(`确定要删除频道 "${name}" 吗？`)) return;
            fetch(`${API_BASE}/youtube/channels/${encodeURIComponent(name)}`, {
                method: 'DELETE'
            }).then(loadChannels);
        }
    </script>
</body>
</html>