<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¾ç½® - Lookoukwindow</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
            padding-bottom: 80px; /* ä¸ºåº•éƒ¨æ‚¬æµ®æ ç•™å‡ºç©ºé—´ */
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        h1 {
            margin-bottom: 30px;
        }
        
        .section {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .section h2 {
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #ccc;
        }
        
        select, input[type="text"], input[type="number"] {
            width: 100%;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            color: #fff;
            font-size: 14px;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            transition: background 0.2s;
        }
        
        button:hover {
            background: #5568d3;
        }

        button.danger {
            background: #e74c3c;
        }
        button.danger:hover {
            background: #c0392b;
        }
        
        button.secondary {
            background: #95a5a6;
        }
        button.secondary:hover {
            background: #7f8c8d;
        }
        
        button.primary-btn {
            background: #27ae60;
            font-weight: bold;
            padding: 10px 20px;
            font-size: 16px;
        }
        button.primary-btn:hover {
            background: #219150;
        }
        
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #667eea;
            text-decoration: none;
        }
        
        .status {
            margin-top: 0;
            padding: 10px;
            border-radius: 4px;
            display: none;
            margin-right: 10px;
        }
        
        .status.success {
            background: rgba(39, 174, 96, 0.2);
            color: #27ae60;
            display: inline-block;
        }
        
        .status.error {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
            display: inline-block;
        }

        /* Bottom Sticky Bar */
        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(26, 26, 26, 0.95);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px 0;
            backdrop-filter: blur(10px);
            z-index: 1000;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
        }

        .bottom-bar-content {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: flex-end;
            align-items: center;
        }

        /* Album Grid */
        .album-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .album-card {
            background: rgba(255,255,255,0.08);
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.2s;
            position: relative;
        }
        
        .album-card:hover {
            transform: translateY(-2px);
            background: rgba(255,255,255,0.12);
        }

        .album-cover {
            height: 150px;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .album-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .album-cover .placeholder {
            color: #666;
            font-size: 40px;
        }

        .album-info {
            padding: 12px;
        }

        .album-name {
            font-weight: bold;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .album-meta {
            font-size: 12px;
            color: #999;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .album-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }

        .album-actions button {
            padding: 4px 8px;
            font-size: 12px;
            margin-right: 5px;
        }

        /* Toggle Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }

        .switch input { 
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #27ae60;
        }

        input:checked + .slider:before {
            transform: translateX(20px);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
        }

        .modal-content {
            background-color: #2d2d2d;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            color: #fff;
            position: relative;
        }

        .close-modal {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-modal:hover {
            color: #fff;
        }

        /* Photo Grid inside Modal */
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .photo-item {
            position: relative;
            aspect-ratio: 1;
            background: #000;
            border-radius: 4px;
            overflow: hidden;
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-item .delete-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(231, 76, 60, 0.8);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .photo-item:hover .delete-btn {
            opacity: 1;
        }
        
        /* Upload Zone */
        .upload-zone {
            border: 2px dashed rgba(255,255,255,0.2);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .upload-zone:hover {
            background: rgba(255,255,255,0.05);
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="back-link">â† è¿”å›ä¸»é¡µ</a>
        <h1>ç³»ç»Ÿè®¾ç½®</h1>
        
        <div class="section">
            <h2>æœ¬åœ°ç›¸å†Œç®¡ç†</h2>
            <div class="form-group">
                <button onclick="showCreateAlbumModal()">+ æ–°å»ºç›¸å†Œ</button>
            </div>
            
            <div id="albumList" class="album-grid">
                <!-- Album cards rendered here -->
            </div>
        </div>
        
        <!-- Main Settings Form Container -->
        <div id="mainSettings">
            <div class="section">
                <h2>æ˜¾ç¤ºè®¾ç½®</h2>
                <div class="form-group">
                    <label>å¸ƒå±€æ¨¡å¼</label>
                    <select id="layout">
                        <option value="side-by-side">å¹¶æ’æ˜¾ç¤º (é»˜è®¤)</option>
                        <option value="stacked">ä¸Šä¸‹å †å </option>
                        <option value="picture-in-picture">ç”»ä¸­ç”»æ¨¡å¼</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>è½®æ’­é—´éš”ï¼ˆç§’ï¼‰</label>
                    <input type="number" id="slideshowInterval" min="1" max="3600" value="10">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="showMetadata"> æ˜¾ç¤ºç…§ç‰‡ä¿¡æ¯ï¼ˆæ–‡ä»¶å/æ—¶é—´ï¼‰
                    </label>
                </div>
                <div class="form-group">
                    <label>å±å¹•æ—‹è½¬</label>
                    <select id="screenRotation">
                        <option value="normal">æ­£å¸¸ (0Â°)</option>
                        <option value="left">å·¦è½¬ (90Â°)</option>
                        <option value="right">å³è½¬ (90Â°)</option>
                        <option value="inverted">å€’ç½® (180Â°)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>æ—¶é—´æ ¼å¼</label>
                    <select id="timeFormat">
                        <option value="24h">24å°æ—¶åˆ¶ (14:30)</option>
                        <option value="12h">12å°æ—¶åˆ¶ (02:30 PM)</option>
                    </select>
                </div>
            </div>

            <div class="section">
                <h2>å¤©æ°”è®¾ç½®</h2>
                <div class="form-group">
                    <label>æ˜¾ç¤ºåœ°å</label>
                    <input type="text" id="weatherLocationName" placeholder="ä¾‹å¦‚ï¼šåŒ—äº¬å¸‚å¤§å…´åŒº">
                </div>
                <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label>çº¬åº¦ (Latitude)</label>
                        <input type="number" id="weatherLatitude" step="0.01" placeholder="ä¾‹å¦‚ï¼š39.73">
                    </div>
                    <div>
                        <label>ç»åº¦ (Longitude)</label>
                        <input type="number" id="weatherLongitude" step="0.01" placeholder="ä¾‹å¦‚ï¼š116.33">
                    </div>
                </div>
                <p style="font-size: 12px; color: #999; margin-bottom: 10px;">
                    æç¤ºï¼šæ‚¨å¯ä»¥åœ¨ Google Maps ä¸Šå³é”®ç‚¹å‡»ä½ç½®è·å–ç»çº¬åº¦ã€‚
                </p>
            </div>
            
            <div class="section">
                <h2>èŠ‚èƒ½æ¨¡å¼è®¾ç½®</h2>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <div class="switch">
                            <input type="checkbox" id="energyEnabled">
                            <span class="slider"></span>
                        </div>
                        <span>å¯ç”¨å¤œé—´ä¼‘çœ æ¨¡å¼ (é»‘å±æ—¶é’Ÿï¼Œåœæ­¢ç›´æ’­å’Œæ•°æ®æ›´æ–°)</span>
                    </label>
                </div>
                <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label>ä¼‘çœ å¼€å§‹æ—¶é—´</label>
                        <input type="time" id="energyStartTime">
                    </div>
                    <div>
                        <label>ä¼‘çœ ç»“æŸæ—¶é—´</label>
                        <input type="time" id="energyEndTime">
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>é‡‘èæ•°æ®è®¾ç½®</h2>
                <div class="form-group">
                    <label>æŒ‡æ•°åˆ—è¡¨ (Symbol, Name)</label>
                    <div style="font-size:12px;color:#999;margin-bottom:5px;">æ¯è¡Œä¸€ä¸ªï¼Œæ ¼å¼ï¼šä»£ç ,åç§° (ä¾‹å¦‚: ^IXIC,çº³æ–¯è¾¾å…‹)</div>
                    <textarea id="financeIndices" rows="6" style="width:100%;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:#fff;padding:8px;border-radius:4px;font-family:monospace;font-size:13px;"></textarea>
                </div>
                <div class="form-group">
                    <label>è‡ªé€‰è‚¡åˆ—è¡¨ (Symbol, Name)</label>
                    <div style="font-size:12px;color:#999;margin-bottom:5px;">æ¯è¡Œä¸€ä¸ªï¼Œæ ¼å¼ï¼šä»£ç ,åç§° (ä¾‹å¦‚: AAPL,è‹¹æœ)</div>
                    <textarea id="financeStocks" rows="6" style="width:100%;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:#fff;padding:8px;border-radius:4px;font-family:monospace;font-size:13px;"></textarea>
                </div>
                <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label>æŒ‡æ•°è·‘é©¬ç¯é€Ÿåº¦ (ç§’)</label>
                        <div style="font-size:12px;color:#999;margin-bottom:5px;">æ•°å€¼è¶Šå¤§æ»šåŠ¨è¶Šæ…¢ (æ¨è: 30)</div>
                        <input type="number" id="financeTickerSpeed" min="5" max="300" value="30">
                    </div>
                    <div>
                        <label>ä¸ªè‚¡åˆ‡æ¢é—´éš” (ç§’)</label>
                        <div style="font-size:12px;color:#999;margin-bottom:5px;">æ¨è: 10</div>
                        <input type="number" id="financeStockSwitchInterval" min="3" max="300" value="10">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h2>YouTube é¢‘é“é…ç½®</h2>
            <div id="channelsList" style="margin-bottom: 15px;"></div>
            <button onclick="addChannel()">+ æ·»åŠ ç›´æ’­é¢‘é“</button>
        </div>
    </div>

    <!-- Sticky Bottom Bar -->
    <div class="bottom-bar">
        <div class="bottom-bar-content">
            <div id="status" class="status"></div>
            <button onclick="saveSettings()" class="primary-btn">ä¿å­˜æ‰€æœ‰è®¾ç½®</button>
        </div>
    </div>

    <!-- Create Album Modal -->
    <div id="createAlbumModal" class="modal">
        <div class="modal-content" style="width: 400px;">
            <span class="close-modal" onclick="closeModal('createAlbumModal')">&times;</span>
            <h2>æ–°å»ºç›¸å†Œ</h2>
            <div class="form-group" style="margin-top: 20px;">
                <label>ç›¸å†Œåç§°</label>
                <input type="text" id="newAlbumName" placeholder="ä¾‹å¦‚ï¼šå®¶åº­åˆå½±">
            </div>
            <div class="form-group">
                <label>æè¿° (å¯é€‰)</label>
                <input type="text" id="newAlbumDesc" placeholder="ç›¸å†Œæè¿°...">
            </div>
            <div style="text-align: right;">
                <button onclick="createAlbum()">åˆ›å»º</button>
            </div>
        </div>
    </div>

    <!-- Album Detail Modal -->
    <div id="albumDetailModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('albumDetailModal')">&times;</span>
            <h2 id="modalAlbumName">ç›¸å†Œè¯¦æƒ…</h2>
            <p id="modalAlbumDesc" style="color: #999; font-size: 14px; margin-bottom: 20px;"></p>
            
            <input type="file" id="photoUpload" multiple accept="image/*" style="display: none;" onchange="handleFileSelect(this)">
            
            <div class="upload-zone" onclick="document.getElementById('photoUpload').click()">
                <p style="font-size: 24px;">ğŸ“¸</p>
                <p>ç‚¹å‡»é€‰æ‹©æˆ–æ‹–æ‹½ç…§ç‰‡åˆ°æ­¤å¤„ä¸Šä¼ </p>
                <p style="font-size: 12px; color: #999;">æ”¯æŒ JPG, PNG, WebP</p>
            </div>

            <div id="uploadProgress" style="display: none; margin-bottom: 10px; color: #27ae60;">
                æ­£åœ¨ä¸Šä¼ ...
            </div>
            
            <div id="photoList" class="photo-grid">
                <!-- Photos rendered here -->
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let currentAlbumId = null;

        // åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            loadChannels();
            loadAlbums();
            
            // æ‹–æ‹½ä¸Šä¼ æ”¯æŒ
            const dropZone = document.querySelector('.upload-zone');
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.style.background = 'rgba(255,255,255,0.1)';
            });
            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropZone.style.background = '';
            });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.style.background = '';
                if(e.dataTransfer.files.length > 0 && currentAlbumId) {
                    uploadPhotos(e.dataTransfer.files);
                }
            });
        });

        // --- Albums Logic ---

        async function loadAlbums() {
            try {
                const res = await fetch(`${API_BASE}/albums`);
                const albums = await res.json();
                renderAlbums(albums);
            } catch (e) {
                console.error("åŠ è½½ç›¸å†Œå¤±è´¥", e);
            }
        }

        function renderAlbums(albums) {
            const container = document.getElementById('albumList');
            container.innerHTML = '';
            
            if (albums.length === 0) {
                container.innerHTML = '<div style="color: #666; grid-column: 1/-1; text-align: center; padding: 20px;">æš‚æ— ç›¸å†Œï¼Œè¯·ç‚¹å‡»æ–°å»º</div>';
                return;
            }

            albums.forEach(album => {
                const coverUrl = album.cover_photo 
                    ? `${API_BASE}/albums/${album.id}/photos/${album.cover_photo}/thumbnail`
                    : null;
                
                const card = document.createElement('div');
                card.className = 'album-card';
                card.innerHTML = `
                    <div class="album-cover" onclick="openAlbum('${album.id}', '${album.name}', '${album.description || ''}')" style="cursor: pointer;">
                        ${coverUrl 
                            ? `<img src="${coverUrl}" alt="${album.name}" loading="lazy">` 
                            : `<div class="placeholder">ğŸ“</div>`
                        }
                    </div>
                    <div class="album-info">
                        <div class="album-name" title="${album.name}">${album.name}</div>
                        <div class="album-meta">
                            <span>${album.photo_count} å¼ ç…§ç‰‡</span>
                            <label class="switch" title="å¯ç”¨è½®æ’­">
                                <input type="checkbox" ${album.active ? 'checked' : ''} onchange="toggleAlbumActive('${album.id}', this.checked)">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="album-actions">
                            <button class="secondary" onclick="openAlbum('${album.id}', '${album.name}', '${album.description || ''}')">ç®¡ç†ç…§ç‰‡</button>
                            <button class="danger" onclick="deleteAlbum('${album.id}', '${album.name}')">åˆ é™¤</button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        async function createAlbum() {
            const name = document.getElementById('newAlbumName').value.trim();
            const desc = document.getElementById('newAlbumDesc').value.trim();
            if (!name) {
                alert("è¯·è¾“å…¥ç›¸å†Œåç§°");
                return;
            }

            const formData = new FormData();
            formData.append('name', name);
            formData.append('description', desc);

            try {
                const res = await fetch(`${API_BASE}/albums`, {
                    method: 'POST',
                    body: formData
                });
                if (res.ok) {
                    closeModal('createAlbumModal');
                    document.getElementById('newAlbumName').value = '';
                    document.getElementById('newAlbumDesc').value = '';
                    loadAlbums();
                } else {
                    alert("åˆ›å»ºå¤±è´¥");
                }
            } catch (e) {
                alert("åˆ›å»ºå‡ºé”™: " + e.message);
            }
        }

        async function toggleAlbumActive(id, active) {
            const formData = new FormData();
            formData.append('active', active);
            try {
                await fetch(`${API_BASE}/albums/${id}`, {
                    method: 'PUT',
                    body: formData
                });
                // ä¸éœ€è¦åˆ·æ–°æ•´ä¸ªåˆ—è¡¨ï¼ŒçŠ¶æ€æ˜¯æœ¬åœ°åˆ‡æ¢çš„
            } catch (e) {
                console.error("æ›´æ–°çŠ¶æ€å¤±è´¥", e);
                loadAlbums(); // å‡ºé”™å›æ»š
            }
        }

        async function deleteAlbum(id, name) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ç›¸å†Œ "${name}" åŠå…¶æ‰€æœ‰ç…§ç‰‡å—ï¼Ÿ`)) return;
            
            try {
                await fetch(`${API_BASE}/albums/${id}`, { method: 'DELETE' });
                loadAlbums();
            } catch (e) {
                alert("åˆ é™¤å¤±è´¥: " + e.message);
            }
        }

        // --- Photo Management Logic ---

        async function openAlbum(id, name, desc) {
            currentAlbumId = id;
            document.getElementById('modalAlbumName').textContent = name;
            document.getElementById('modalAlbumDesc').textContent = desc;
            
            // Show modal
            document.getElementById('albumDetailModal').style.display = 'block';
            
            // Load photos
            loadPhotos(id);
        }

        async function loadPhotos(albumId) {
            const container = document.getElementById('photoList');
            container.innerHTML = '<div style="color:#999">åŠ è½½ä¸­...</div>';
            
            try {
                const res = await fetch(`${API_BASE}/albums/${albumId}/photos`);
                const photos = await res.json();
                renderPhotos(photos);
            } catch (e) {
                container.innerHTML = 'åŠ è½½å¤±è´¥';
            }
        }

        function renderPhotos(photos) {
            const container = document.getElementById('photoList');
            container.innerHTML = '';
            
            photos.forEach(photo => {
                const div = document.createElement('div');
                div.className = 'photo-item';
                div.innerHTML = `
                    <img src="${photo.thumbnail_url}" loading="lazy" title="${photo.filename}">
                    <div class="delete-btn" onclick="deletePhoto('${photo.filename}')" title="åˆ é™¤">Ã—</div>
                `;
                container.appendChild(div);
            });
        }

        function handleFileSelect(input) {
            if (input.files.length > 0) {
                uploadPhotos(input.files);
            }
        }

        async function uploadPhotos(fileList) {
            if (!currentAlbumId) return;
            
            const progressDiv = document.getElementById('uploadProgress');
            progressDiv.style.display = 'block';
            progressDiv.textContent = `æ­£åœ¨ä¸Šä¼  ${fileList.length} å¼ ç…§ç‰‡...`;
            
            const formData = new FormData();
            for (let i = 0; i < fileList.length; i++) {
                formData.append('files', fileList[i]);
            }

            try {
                const res = await fetch(`${API_BASE}/albums/${currentAlbumId}/photos`, {
                    method: 'POST',
                    body: formData
                });
                const result = await res.json();
                progressDiv.textContent = "ä¸Šä¼ å®Œæˆï¼";
                setTimeout(() => progressDiv.style.display = 'none', 2000);
                
                // Reload photos
                loadPhotos(currentAlbumId);
                // Update album list (for cover/count)
                loadAlbums();
            } catch (e) {
                progressDiv.textContent = "ä¸Šä¼ å¤±è´¥: " + e.message;
                progressDiv.style.color = '#e74c3c';
            }
        }

        async function deletePhoto(filename) {
            if (!confirm('ç¡®å®šåˆ é™¤è¿™å¼ ç…§ç‰‡å—ï¼Ÿ')) return;
            
            try {
                await fetch(`${API_BASE}/albums/${currentAlbumId}/photos/${filename}`, {
                    method: 'DELETE'
                });
                loadPhotos(currentAlbumId);
                loadAlbums();
            } catch (e) {
                alert("åˆ é™¤å¤±è´¥");
            }
        }

        // --- Modal Utilities ---
        function showCreateAlbumModal() {
            document.getElementById('createAlbumModal').style.display = 'block';
            document.getElementById('newAlbumName').focus();
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
            if (id === 'albumDetailModal') {
                currentAlbumId = null;
            }
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = "none";
                if (event.target.id === 'albumDetailModal') {
                    currentAlbumId = null;
                }
            }
        }

        // --- Existing Settings Logic (Youtube/UI) ---
        
        async function loadSettings() {
            try {
                const response = await fetch(`${API_BASE}/settings/`);
                const data = await response.json();
                
                document.getElementById('layout').value = data.layout || 'side-by-side';
                document.getElementById('slideshowInterval').value = data.slideshow_interval_seconds || 10;
                document.getElementById('showMetadata').checked = data.show_metadata !== false;
                document.getElementById('screenRotation').value = data.screen_rotation || 'normal';
                document.getElementById('timeFormat').value = data.time_format || '24h';
                document.getElementById('weatherLocationName').value = data.weather_location_name || 'åŒ—äº¬å¸‚å¤§å…´åŒº';
                document.getElementById('weatherLatitude').value = data.weather_latitude || 39.73;
                document.getElementById('weatherLongitude').value = data.weather_longitude || 116.33;
                
                // Load finance settings (convert array to CSV-like string)
                const indices = data.finance_indices || [];
                document.getElementById('financeIndices').value = indices.map(i => `${i.symbol},${i.name}`).join('\n');
                
                const stocks = data.finance_stocks || [];
                document.getElementById('financeStocks').value = stocks.map(s => `${s.symbol},${s.name}`).join('\n');

                document.getElementById('financeTickerSpeed').value = data.finance_ticker_speed_seconds || 30;
                document.getElementById('financeStockSwitchInterval').value = data.finance_stock_switch_interval_seconds || 10;

                // Energy
                document.getElementById('energyEnabled').checked = data.energy_enabled !== false;
                document.getElementById('energyStartTime').value = data.energy_start_time || '22:30';
                document.getElementById('energyEndTime').value = data.energy_end_time || '05:30';

            } catch (error) {
                console.error('åŠ è½½è®¾ç½®å¤±è´¥:', error);
            }
        }

        async function saveSettings() {
            // Helper to parse textarea to array of objects
            const parseFinanceConfig = (text) => {
                return text.split('\n')
                    .map(line => line.trim())
                    .filter(line => line && line.includes(','))
                    .map(line => {
                        const [symbol, ...nameParts] = line.split(',');
                        return { symbol: symbol.trim(), name: nameParts.join(',').trim() };
                    });
            };

            const settings = {
                layout: document.getElementById('layout').value,
                slideshow_interval_seconds: parseInt(document.getElementById('slideshowInterval').value),
                show_metadata: document.getElementById('showMetadata').checked,
                screen_rotation: document.getElementById('screenRotation').value,
                time_format: document.getElementById('timeFormat').value,
                weather_location_name: document.getElementById('weatherLocationName').value,
                weather_latitude: parseFloat(document.getElementById('weatherLatitude').value),
                weather_longitude: parseFloat(document.getElementById('weatherLongitude').value),
                finance_indices: parseFinanceConfig(document.getElementById('financeIndices').value),
                finance_stocks: parseFinanceConfig(document.getElementById('financeStocks').value),
                finance_ticker_speed_seconds: parseInt(document.getElementById('financeTickerSpeed').value),
                finance_stock_switch_interval_seconds: parseInt(document.getElementById('financeStockSwitchInterval').value),
                energy_enabled: document.getElementById('energyEnabled').checked,
                energy_start_time: document.getElementById('energyStartTime').value,
                energy_end_time: document.getElementById('energyEndTime').value
            };
            
            try {
                await fetch(`${API_BASE}/settings/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
                showStatus('è®¾ç½®ä¿å­˜æˆåŠŸ', 'success');
            } catch (error) {
                showStatus('ä¿å­˜å¤±è´¥', 'error');
            }
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            setTimeout(() => {
                statusDiv.className = 'status';
            }, 3000);
        }

        async function loadChannels() {
            try {
                const response = await fetch(`${API_BASE}/youtube/channels`);
                const data = await response.json();
                const channelsList = document.getElementById('channelsList');
                channelsList.innerHTML = '';
                
                data.channels.forEach(channel => {
                    const div = document.createElement('div');
                    div.style.marginBottom = '10px';
                    div.style.background = 'rgba(255,255,255,0.1)';
                    div.style.padding = '8px';
                    div.style.borderRadius = '4px';
                    div.style.display = 'flex';
                    div.style.justifyContent = 'space-between';
                    div.style.alignItems = 'center';
                    
                    div.innerHTML = `
                        <span>${channel.name}</span>
                        ${channel.name !== 'NASA TV' && channel.name !== 'ISS Live' && channel.name !== 'NASA Live' ? 
                            `<button onclick="deleteChannel('${channel.name}')" style="background:#e74c3c;margin:0;padding:4px 8px;">åˆ é™¤</button>` : 
                            '<span style="font-size:12px;color:#999">é¢„è®¾</span>'}
                    `;
                    channelsList.appendChild(div);
                });
            } catch (error) {
                console.error('åŠ è½½é¢‘é“å¤±è´¥:', error);
            }
        }

        function addChannel() {
            const name = prompt('è¯·è¾“å…¥é¢‘é“åç§°:');
            if (!name) return;
            const url = prompt('è¯·è¾“å…¥ YouTube URL:');
            if (!url) return;
            
            fetch(`${API_BASE}/youtube/channels`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, url })
            }).then(loadChannels);
        }

        function deleteChannel(name) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤é¢‘é“ "${name}" å—ï¼Ÿ`)) return;
            fetch(`${API_BASE}/youtube/channels/${encodeURIComponent(name)}`, {
                method: 'DELETE'
            }).then(loadChannels);
        }
    </script>
</body>
</html>
