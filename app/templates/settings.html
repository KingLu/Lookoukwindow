<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¾ç½® - Lookoukwindow</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, -apple-system, sans-serif; background: #1a1a1a; color: #fff; padding-bottom: 80px; }
        
        /* Admin Nav */
        .admin-nav {
            background: #2d2d2d;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            align-items: center;
            border-bottom: 1px solid #333;
        }
        .admin-nav a {
            color: #aaa;
            text-decoration: none;
            font-size: 14px;
            padding: 5px 10px;
            border-radius: 4px;
        }
        .admin-nav a.active { background: #444; color: #fff; }
        .admin-nav a:hover { color: #fff; }
        .back-home { margin-right: auto; color: #667eea !important; font-weight: bold; }

        .container { max-width: 900px; margin: 0 auto; padding: 0 20px; }
        
        h1 { margin-bottom: 30px; }
        
        .section {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .section h2 {
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 10px;
        }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: #ccc; }
        
        select, input[type="text"], input[type="number"], input[type="time"], textarea {
            width: 100%;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            color: #fff;
            font-size: 14px;
        }
        
        button {
            background: #667eea; color: white; border: none; padding: 8px 16px; border-radius: 4px;
            cursor: pointer; font-size: 14px; margin-right: 10px; transition: background 0.2s;
        }
        button:hover { background: #5568d3; }
        
        button.danger { background: #e74c3c; }
        button.danger:hover { background: #c0392b; }
        
        button.primary-btn {
            background: #27ae60; font-weight: bold; padding: 10px 20px; font-size: 16px;
        }
        button.primary-btn:hover { background: #219150; }
        
        .status {
            margin-top: 0; padding: 10px; border-radius: 4px; display: none; margin-right: 10px;
        }
        .status.success { background: rgba(39, 174, 96, 0.2); color: #27ae60; display: inline-block; }
        .status.error { background: rgba(231, 76, 60, 0.2); color: #e74c3c; display: inline-block; }

        /* Bottom Sticky Bar */
        .bottom-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: rgba(26, 26, 26, 0.95); border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px 0; backdrop-filter: blur(10px); z-index: 1000;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
        }
        .bottom-bar-content {
            max-width: 900px; margin: 0 auto; padding: 0 20px;
            display: flex; justify-content: flex-end; align-items: center;
        }

        /* Toggle Switch */
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #27ae60; }
        input:checked + .slider:before { transform: translateX(20px); }
    </style>
</head>
<body>

    <div class="admin-nav">
        <a href="/" class="back-home">â† è¿”å›å±•ç¤ºå±</a>
        <a href="/settings" class="active">ç³»ç»Ÿè®¾ç½®</a>
        <a href="/admin/library">ç…§ç‰‡åº“</a>
        <a href="/admin/albums">ç›¸å†Œç®¡ç†</a>
        <a href="/admin/stocks">è‚¡ç¥¨é…ç½®</a>
    </div>

    <div class="container">
        <h1>ç³»ç»Ÿè®¾ç½®</h1>
        
        <!-- Main Settings Form Container -->
        <div id="mainSettings">
            <div class="section">
                <h2>æ˜¾ç¤ºè®¾ç½®</h2>
                <div class="form-group">
                    <label>å¸ƒå±€æ¨¡å¼</label>
                    <select id="layout">
                        <option value="side-by-side">å¹¶æ’æ˜¾ç¤º (é»˜è®¤)</option>
                        <option value="stacked">ä¸Šä¸‹å †å </option>
                        <option value="picture-in-picture">ç”»ä¸­ç”»æ¨¡å¼</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>è½®æ’­é—´éš”ï¼ˆç§’ï¼‰</label>
                    <input type="number" id="slideshowInterval" min="1" max="3600" value="10">
                </div>
                <div class="form-group">
                    <label>æ’­æ”¾é¡ºåº</label>
                    <select id="slideshowOrder">
                        <option value="shuffle">éšæœºæ’­æ”¾ (é»˜è®¤)</option>
                        <option value="sequential">é¡ºåºæ’­æ”¾</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>åˆ‡æ¢æ•ˆæœ</label>
                    <select id="slideshowTransition">
                        <option value="fade">æ·¡å…¥æ·¡å‡º (é»˜è®¤)</option>
                        <option value="none">ç›´æ¥åˆ‡æ¢</option>
                        <option value="slide-left">å‘å·¦æ»‘åŠ¨</option>
                        <option value="slide-right">å‘å³æ»‘åŠ¨</option>
                        <option value="slide-up">å‘ä¸Šæ»‘åŠ¨</option>
                        <option value="slide-down">å‘ä¸‹æ»‘åŠ¨</option>
                        <option value="zoom-in">æ¸å¤§ (Zoom In)</option>
                        <option value="zoom-out">æ¸å° (Zoom Out)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="showMetadata"> æ˜¾ç¤ºç…§ç‰‡ä¿¡æ¯ï¼ˆæ–‡ä»¶å/æ—¶é—´ï¼‰
                    </label>
                </div>
                <div class="form-group">
                    <label>å±å¹•æ—‹è½¬</label>
                    <select id="screenRotation">
                        <option value="normal">æ­£å¸¸ (0Â°)</option>
                        <option value="left">å·¦è½¬ (90Â°)</option>
                        <option value="right">å³è½¬ (90Â°)</option>
                        <option value="inverted">å€’ç½® (180Â°)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>æ—¶é—´æ ¼å¼</label>
                    <select id="timeFormat">
                        <option value="24h">24å°æ—¶åˆ¶ (14:30)</option>
                        <option value="12h">12å°æ—¶åˆ¶ (02:30 PM)</option>
                    </select>
                </div>
            </div>

            <div class="section">
                <h2>å¤©æ°”è®¾ç½®</h2>
                <div class="form-group">
                    <label>æ˜¾ç¤ºåœ°å</label>
                    <input type="text" id="weatherLocationName" placeholder="ä¾‹å¦‚ï¼šåŒ—äº¬å¸‚å¤§å…´åŒº">
                </div>
                <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label>çº¬åº¦ (Latitude)</label>
                        <input type="number" id="weatherLatitude" step="0.01" placeholder="ä¾‹å¦‚ï¼š39.73">
                    </div>
                    <div>
                        <label>ç»åº¦ (Longitude)</label>
                        <input type="number" id="weatherLongitude" step="0.01" placeholder="ä¾‹å¦‚ï¼š116.33">
                    </div>
                </div>
                <p style="font-size: 12px; color: #999; margin-bottom: 10px;">
                    æç¤ºï¼šæ‚¨å¯ä»¥åœ¨ Google Maps ä¸Šå³é”®ç‚¹å‡»ä½ç½®è·å–ç»çº¬åº¦ã€‚
                </p>
            </div>
            
            <div class="section">
                <h2>èŠ‚èƒ½æ¨¡å¼è®¾ç½®</h2>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <div class="switch">
                            <input type="checkbox" id="energyEnabled">
                            <span class="slider"></span>
                        </div>
                        <span>å¯ç”¨å¤œé—´ä¼‘çœ æ¨¡å¼ (é»‘å±æ—¶é’Ÿï¼Œåœæ­¢ç›´æ’­å’Œæ•°æ®æ›´æ–°)</span>
                    </label>
                </div>
                <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label>ä¼‘çœ å¼€å§‹æ—¶é—´</label>
                        <input type="time" id="energyStartTime">
                    </div>
                    <div>
                        <label>ä¼‘çœ ç»“æŸæ—¶é—´</label>
                        <input type="time" id="energyEndTime">
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>é‡‘èæ•°æ®è®¾ç½®</h2>
                <!-- æŒ‡æ•°å’Œè‡ªé€‰è‚¡åˆ—è¡¨å·²ç§»é™¤ï¼Œç§»è‡³è‚¡ç¥¨é…ç½®é¡µ -->
                <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label>æŒ‡æ•°è·‘é©¬ç¯é€Ÿåº¦ (ç§’)</label>
                        <div style="font-size:12px;color:#999;margin-bottom:5px;">æ•°å€¼è¶Šå¤§æ»šåŠ¨è¶Šæ…¢ (æ¨è: 30)</div>
                        <input type="number" id="financeTickerSpeed" min="5" max="300" value="30">
                    </div>
                    <div>
                        <label>ä¸ªè‚¡åˆ‡æ¢é—´éš” (ç§’)</label>
                        <div style="font-size:12px;color:#999;margin-bottom:5px;">æ¨è: 10</div>
                        <input type="number" id="financeStockSwitchInterval" min="3" max="300" value="10">
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <a href="/admin/stocks" style="color: #3498db; text-decoration: none; display: flex; align-items: center; gap: 5px;">
                        ğŸ‘‰ ç®¡ç†æŒ‡æ•°å’Œè‡ªé€‰è‚¡åˆ—è¡¨
                    </a>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h2>YouTube é¢‘é“é…ç½®</h2>
            <div id="channelsList" style="margin-bottom: 15px;"></div>
            <button onclick="addChannel()">+ æ·»åŠ ç›´æ’­é¢‘é“</button>
        </div>
    </div>

    <!-- Sticky Bottom Bar -->
    <div class="bottom-bar">
        <div class="bottom-bar-content">
            <div id="status" class="status"></div>
            <button onclick="saveSettings()" class="primary-btn">ä¿å­˜æ‰€æœ‰è®¾ç½®</button>
        </div>
    </div>

    <script>
        const API_BASE = '/api';

        // åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            loadChannels();
        });

        // --- Existing Settings Logic (Youtube/UI) ---
        
        async function loadSettings() {
            try {
                const response = await fetch(`${API_BASE}/settings/`);
                const data = await response.json();
                
                document.getElementById('layout').value = data.layout || 'side-by-side';
                document.getElementById('slideshowInterval').value = data.slideshow_interval_seconds || 10;
                document.getElementById('slideshowOrder').value = data.slideshow_order || 'shuffle';
                document.getElementById('slideshowTransition').value = data.slideshow_transition || 'fade';
                document.getElementById('showMetadata').checked = data.show_metadata !== false;
                document.getElementById('screenRotation').value = data.screen_rotation || 'normal';
                document.getElementById('timeFormat').value = data.time_format || '24h';
                document.getElementById('weatherLocationName').value = data.weather_location_name || 'åŒ—äº¬å¸‚å¤§å…´åŒº';
                document.getElementById('weatherLatitude').value = data.weather_latitude || 39.73;
                document.getElementById('weatherLongitude').value = data.weather_longitude || 116.33;
                
                document.getElementById('financeTickerSpeed').value = data.finance_ticker_speed_seconds || 30;
                document.getElementById('financeStockSwitchInterval').value = data.finance_stock_switch_interval_seconds || 10;

                // Energy
                document.getElementById('energyEnabled').checked = data.energy_enabled !== false;
                document.getElementById('energyStartTime').value = data.energy_start_time || '22:30';
                document.getElementById('energyEndTime').value = data.energy_end_time || '05:30';

            } catch (error) {
                console.error('åŠ è½½è®¾ç½®å¤±è´¥:', error);
            }
        }

        async function saveSettings() {
            const settings = {
                layout: document.getElementById('layout').value,
                slideshow_interval_seconds: parseInt(document.getElementById('slideshowInterval').value),
                slideshow_order: document.getElementById('slideshowOrder').value,
                slideshow_transition: document.getElementById('slideshowTransition').value,
                show_metadata: document.getElementById('showMetadata').checked,
                screen_rotation: document.getElementById('screenRotation').value,
                time_format: document.getElementById('timeFormat').value,
                weather_location_name: document.getElementById('weatherLocationName').value,
                weather_latitude: parseFloat(document.getElementById('weatherLatitude').value),
                weather_longitude: parseFloat(document.getElementById('weatherLongitude').value),
                finance_ticker_speed_seconds: parseInt(document.getElementById('financeTickerSpeed').value),
                finance_stock_switch_interval_seconds: parseInt(document.getElementById('financeStockSwitchInterval').value),
                energy_enabled: document.getElementById('energyEnabled').checked,
                energy_start_time: document.getElementById('energyStartTime').value,
                energy_end_time: document.getElementById('energyEndTime').value
            };
            
            try {
                await fetch(`${API_BASE}/settings/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
                showStatus('è®¾ç½®ä¿å­˜æˆåŠŸ', 'success');
            } catch (error) {
                showStatus('ä¿å­˜å¤±è´¥', 'error');
            }
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            setTimeout(() => {
                statusDiv.className = 'status';
            }, 3000);
        }

        async function loadChannels() {
            try {
                const response = await fetch(`${API_BASE}/youtube/channels`);
                const data = await response.json();
                const channelsList = document.getElementById('channelsList');
                channelsList.innerHTML = '';
                
                data.channels.forEach(channel => {
                    const isDefault = channel.name === data.default_channel;
                    
                    const div = document.createElement('div');
                    div.style.marginBottom = '10px';
                    div.style.background = 'rgba(255,255,255,0.1)';
                    div.style.padding = '8px';
                    div.style.borderRadius = '4px';
                    div.style.display = 'flex';
                    div.style.justifyContent = 'space-between';
                    div.style.alignItems = 'center';
                    
                    let actionsHtml = '';
                    
                    // é»˜è®¤é¢‘é“çŠ¶æ€/æŒ‰é’®
                    if (isDefault) {
                        actionsHtml += `<span class="status success" style="display:inline-block; margin-right:10px; font-size:12px; padding:2px 6px;">å½“å‰é»˜è®¤</span>`;
                    } else {
                        actionsHtml += `<button onclick="setDefaultChannel('${channel.name}')" style="background:#3498db; margin-right:10px; padding:4px 8px; font-size:12px;">è®¾ä¸ºé»˜è®¤</button>`;
                    }

                    // åˆ é™¤æŒ‰é’® (é¢„è®¾é¢‘é“ä¸å¯åˆ é™¤)
                    const isPreset = ['NASA TV', 'ISS Live', 'NASA Live'].includes(channel.name);
                    if (!isPreset) {
                        actionsHtml += `<button onclick="deleteChannel('${channel.name}')" style="background:#e74c3c; margin:0; padding:4px 8px; font-size:12px;">åˆ é™¤</button>`;
                    } else {
                        actionsHtml += `<span style="font-size:12px;color:#999">é¢„è®¾</span>`;
                    }
                    
                    div.innerHTML = `
                        <span style="font-weight: ${isDefault ? 'bold' : 'normal'}">${channel.name}</span>
                        <div>${actionsHtml}</div>
                    `;
                    channelsList.appendChild(div);
                });
            } catch (error) {
                console.error('åŠ è½½é¢‘é“å¤±è´¥:', error);
            }
        }

        async function setDefaultChannel(name) {
            try {
                const res = await fetch(`${API_BASE}/youtube/default?channel_name=${encodeURIComponent(name)}`, {
                    method: 'POST'
                });
                if (res.ok) {
                    showStatus(`å·²åˆ‡æ¢é»˜è®¤é¢‘é“ä¸º: ${name}`, 'success');
                    loadChannels(); // é‡æ–°åŠ è½½åˆ—è¡¨ä»¥æ›´æ–°çŠ¶æ€
                } else {
                    showStatus('è®¾ç½®å¤±è´¥', 'error');
                }
            } catch (e) {
                showStatus('è®¾ç½®å¤±è´¥', 'error');
            }
        }

        function addChannel() {
            const name = prompt('è¯·è¾“å…¥é¢‘é“åç§°:');
            if (!name) return;
            const url = prompt('è¯·è¾“å…¥ YouTube URL:');
            if (!url) return;
            
            fetch(`${API_BASE}/youtube/channels`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, url })
            }).then(loadChannels);
        }

        function deleteChannel(name) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤é¢‘é“ "${name}" å—ï¼Ÿ`)) return;
            fetch(`${API_BASE}/youtube/channels/${encodeURIComponent(name)}`, {
                method: 'DELETE'
            }).then(loadChannels);
        }
    </script>
</body>
</html>