# Lookoukwindow 程序设计文档

> 本文档面向开发者，详细介绍 Lookoukwindow 的系统架构、技术实现和设计决策。

---

## 目录

- [技术栈概览](#技术栈概览)
- [系统架构](#系统架构)
  - [整体架构](#整体架构)
  - [目录结构](#目录结构)
  - [分层设计](#分层设计)
- [核心模块设计](#核心模块设计)
  - [配置管理 (Config)](#配置管理-config)
  - [认证模块 (Auth)](#认证模块-auth)
  - [照片库服务 (LibraryService)](#照片库服务-libraryservice)
  - [相册服务 (AlbumService)](#相册服务-albumservice)
  - [金融服务 (FinanceService)](#金融服务-financeservice)
  - [YouTube服务 (YouTubeService)](#youtube服务-youtubeservice)
- [API 设计](#api-设计)
  - [认证 API](#认证-api)
  - [相册 API](#相册-api)
  - [照片库 API](#照片库-api)
  - [金融 API](#金融-api)
  - [YouTube API](#youtube-api)
  - [设置 API](#设置-api)
- [前端架构](#前端架构)
  - [模板渲染](#模板渲染)
  - [JavaScript 模块](#javascript-模块)
  - [样式设计](#样式设计)
- [数据存储设计](#数据存储设计)
  - [配置文件](#配置文件)
  - [照片存储](#照片存储)
  - [索引文件](#索引文件)
- [安全设计](#安全设计)
- [部署架构](#部署架构)
- [性能优化](#性能优化)
- [扩展指南](#扩展指南)

---

## 技术栈概览

### 后端技术

| 技术 | 版本 | 用途 |
|------|------|------|
| **FastAPI** | 0.104.1 | Web 框架，异步高性能 |
| **Uvicorn** | 0.24.0 | ASGI 服务器 |
| **Jinja2** | 3.1.2 | 模板引擎 |
| **Pydantic** | 2.9.0+ | 数据验证和序列化 |
| **Pillow** | 10.2.0+ | 图片处理（压缩、旋转、缩略图） |
| **yfinance** | 0.2.36+ | 金融数据获取 |
| **geopy** | 2.4.0+ | 逆地理编码 |
| **passlib + bcrypt** | - | 密码哈希 |
| **python-jose** | 3.3.0 | JWT 令牌 |
| **PyYAML** | 6.0.1 | YAML 配置解析 |

### 前端技术

| 技术 | 用途 |
|------|------|
| **原生 JavaScript** | 交互逻辑 |
| **Chart.js** | 金融图表渲染 |
| **lunar-javascript** | 农历转换 |
| **CSS3** | 样式和动画 |

### 第三方服务

| 服务 | 用途 |
|------|------|
| **YouTube Embed API** | 直播嵌入 |
| **Yahoo Finance (via yfinance)** | 金融数据 |
| **Open-Meteo API** | 天气数据 |
| **Nominatim (OSM)** | 逆地理编码 |

---

## 系统架构

### 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        客户端 (Browser)                          │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  Jinja2 Templates + JavaScript + CSS                     │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐│   │
│  │  │ Chart.js    │ │ lunar-js    │ │ YouTube Embed API   ││   │
│  │  └─────────────┘ └─────────────┘ └─────────────────────┘│   │
│  └──────────────────────────────────────────────────────────┘   │
└───────────────────────────────┬─────────────────────────────────┘
                                │ HTTP/REST
┌───────────────────────────────▼─────────────────────────────────┐
│                     FastAPI Application                          │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                    Middleware Layer                       │   │
│  │  [CORS] [Auth] [Referrer-Policy] [Permissions-Policy]    │   │
│  └──────────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                     API Router Layer                      │   │
│  │  ┌────────┐ ┌────────┐ ┌─────────┐ ┌─────────┐ ┌───────┐│   │
│  │  │ auth   │ │ albums │ │ library │ │ finance │ │youtube││   │
│  │  └────────┘ └────────┘ └─────────┘ └─────────┘ └───────┘│   │
│  └──────────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                    Service Layer                          │   │
│  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────────┐  │   │
│  │  │AlbumService  │ │LibraryService│ │FinanceService    │  │   │
│  │  └──────────────┘ └──────────────┘ └──────────────────┘  │   │
│  └──────────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                     Core Layer                            │   │
│  │  ┌──────────────────────┐  ┌──────────────────────────┐  │   │
│  │  │      Config          │  │       AuthManager        │  │   │
│  │  └──────────────────────┘  └──────────────────────────┘  │   │
│  └──────────────────────────────────────────────────────────┘   │
└───────────────────────────────┬─────────────────────────────────┘
                                │
┌───────────────────────────────▼─────────────────────────────────┐
│                      Data Storage Layer                          │
│  ┌─────────────┐ ┌─────────────┐ ┌───────────────────────────┐  │
│  │ config.yaml │ │ library.json│ │  data/library/*           │  │
│  │             │ │ stocks.json │ │  data/thumbnails/*        │  │
│  │             │ │indices.json │ │  data/web_images/*        │  │
│  └─────────────┘ └─────────────┘ └───────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                                │
┌───────────────────────────────▼─────────────────────────────────┐
│                    External Services                             │
│  ┌─────────────┐ ┌─────────────┐ ┌────────────┐ ┌────────────┐  │
│  │ Yahoo       │ │ Open-Meteo  │ │ YouTube    │ │ Nominatim  │  │
│  │ Finance     │ │ Weather API │ │ Embed      │ │ Geocoding  │  │
│  └─────────────┘ └─────────────┘ └────────────┘ └────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

### 目录结构

```
Lookoukwindow/
├── app/                          # 主应用代码
│   ├── __init__.py
│   ├── main.py                   # FastAPI 应用入口和路由注册
│   │
│   ├── api/                      # API 路由层
│   │   ├── __init__.py
│   │   ├── albums.py             # 相册 API 端点
│   │   ├── auth.py               # 认证 API 端点
│   │   ├── finance.py            # 金融数据 API 端点
│   │   ├── library.py            # 照片库 API 端点
│   │   ├── settings.py           # 设置 API 端点
│   │   └── youtube.py            # YouTube API 端点
│   │
│   ├── core/                     # 核心模块
│   │   ├── __init__.py
│   │   ├── auth.py               # 认证管理器 (JWT)
│   │   └── config.py             # 配置管理类
│   │
│   ├── services/                 # 业务服务层
│   │   ├── __init__.py
│   │   ├── album_service.py      # 相册业务逻辑
│   │   ├── finance_service.py    # 金融配置服务
│   │   ├── library_service.py    # 照片库服务
│   │   ├── youtube_fallback.py   # YouTube 备用方案
│   │   └── youtube.py            # YouTube 服务
│   │
│   ├── templates/                # Jinja2 HTML 模板
│   │   ├── base.html             # 基础模板
│   │   ├── index.html            # 首页（主展示页）
│   │   ├── login.html            # 登录页
│   │   ├── settings.html         # 设置页
│   │   ├── setup.html            # 初始设置页
│   │   ├── albums.html           # 相册管理页
│   │   ├── library.html          # 照片库管理页
│   │   ├── stocks.html           # 股票配置页
│   │   └── youtube_fallback.html # YouTube 备用页
│   │
│   └── static/                   # 静态资源
│       └── icons/                # SVG 图标
│           ├── calendar.svg
│           ├── camera.svg
│           ├── folder.svg
│           └── location.svg
│
├── data/                         # 数据存储目录
│   ├── config.yaml               # 配置文件
│   ├── config.yaml.example       # 配置文件示例
│   ├── library/                  # 原始照片库
│   │   └── library.json          # 照片索引
│   ├── albums/                   # 相册元数据
│   │   └── {album_id}/
│   │       └── metadata.json
│   ├── thumbnails/               # 缩略图 (400px)
│   ├── web_images/               # Web 优化图 (1280px)
│   ├── stocks.json               # 股票配置
│   └── indices.json              # 指数配置
│
├── log/                          # 日志目录
│   └── app.log                   # 应用日志（按天轮转）
│
├── scripts/                      # 脚本文件
│   ├── install.sh                # 安装脚本
│   ├── kiosk.sh                  # Kiosk 模式启动脚本
│   ├── package.sh                # 打包脚本
│   └── reset_password.py         # 密码重置脚本
│
├── docs/                         # 文档目录
├── release/                      # 发布包目录
├── venv/                         # Python 虚拟环境
│
├── run.py                        # 应用启动入口
├── requirements.txt              # Python 依赖
├── lookoukwindow.service         # systemd 服务文件
├── LICENSE                       # GPL-3.0 许可证
├── README.md                     # 项目说明
└── CHANGELOG.md                  # 更新日志
```

### 分层设计

应用采用经典的三层架构：

```
┌─────────────────────────────────────┐
│         Presentation Layer          │  ← API 路由 + 模板渲染
│     (app/api/* + app/templates/*)   │
├─────────────────────────────────────┤
│          Business Layer             │  ← 业务逻辑服务
│         (app/services/*)            │
├─────────────────────────────────────┤
│           Core Layer                │  ← 核心功能（配置、认证）
│          (app/core/*)               │
├─────────────────────────────────────┤
│          Data Layer                 │  ← 文件系统存储
│         (data/* + JSON)             │
└─────────────────────────────────────┘
```

---

## 核心模块设计

### 配置管理 (Config)

**文件**: `app/core/config.py`

**职责**:
- 加载/保存 YAML 配置文件
- 提供点号分隔的嵌套键访问（如 `config.get('youtube.default_channel')`）
- 管理数据目录路径
- 密码哈希和验证

**关键设计**:

```python
class Config:
    def __init__(self, config_path: Optional[str] = None):
        self.project_root = Path(__file__).parent.parent.parent
        self.config_path = config_path or self._get_default_config_path()
        self._config = self._load_config()
        self._ensure_directories()
        self._ensure_security()
    
    def get(self, key: str, default=None):
        """支持点号分隔的嵌套键访问"""
        keys = key.split('.')
        value = self._config
        for k in keys:
            if isinstance(value, dict):
                value = value.get(k)
                if value is None:
                    return default
            else:
                return default
        return value
    
    def set(self, key: str, value):
        """支持点号分隔的嵌套键设置"""
        keys = key.split('.')
        config = self._config
        for k in keys[:-1]:
            if k not in config:
                config[k] = {}
            config = config[k]
        config[keys[-1]] = value
```

**属性路径**:

| 属性 | 路径 |
|------|------|
| `data_dir` | `项目根目录/data` |
| `library_dir` | `data_dir/library` |
| `albums_dir` | `data_dir/albums` |
| `thumbnails_dir` | `data_dir/thumbnails` |
| `web_images_dir` | `data_dir/web_images` |

---

### 认证模块 (Auth)

**文件**: `app/core/auth.py`

**认证流程**:

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   用户登录      │ ──▶ │  验证密码       │ ──▶ │  生成 JWT      │
│  (POST /login)  │     │ (bcrypt verify) │     │  (python-jose)  │
└─────────────────┘     └─────────────────┘     └─────────────────┘
                                                         │
                                                         ▼
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   后续请求      │ ──▶ │ 中间件验证      │ ──▶ │  解码验证 JWT  │
│  (Cookie/Header)│     │  AuthMiddleware │     │                 │
└─────────────────┘     └─────────────────┘     └─────────────────┘
```

**关键实现**:

```python
class AuthManager:
    def __init__(self, config: Config):
        self.config = config
        self.algorithm = "HS256"
        self.access_token_expire_minutes = 60 * 24 * 7  # 7天
    
    def create_access_token(self, data: dict) -> str:
        to_encode = data.copy()
        expire = datetime.utcnow() + timedelta(minutes=self.access_token_expire_minutes)
        to_encode.update({"exp": expire})
        return jwt.encode(to_encode, self.config.session_secret, algorithm=self.algorithm)
    
    async def get_current_user(self, request: Request) -> bool:
        # 1. 从 Cookie 获取 token
        token = request.cookies.get("access_token")
        # 2. 或从 Authorization Header 获取
        if not token:
            authorization = await self.security(request)
            if authorization:
                token = authorization.credentials
        # 3. 验证 token
        if not token:
            return False
        payload = self.verify_token(token)
        return payload is not None
```

**密码安全**:
- 使用 bcrypt 算法哈希存储
- 限制密码长度不超过 72 字节（bcrypt 限制）
- Session Secret 自动生成（`secrets.token_urlsafe(32)`）

---

### 照片库服务 (LibraryService)

**文件**: `app/services/library_service.py`

**核心职责**:
- 照片上传和去重
- 生成衍生图（缩略图、Web 优化版）
- EXIF 元数据解析
- 逆地理编码
- 照片旋转（仅修改展示版）

**存储策略**:

```
上传照片
    │
    ▼
┌─────────────────────────────────────────────────────────────────┐
│ 1. 计算 SHA-256 哈希值                                          │
│ 2. 检查是否重复（对比哈希）                                      │
│ 3. 保存原图到 data/library/ （不做任何处理）                     │
│ 4. 生成 1280px Web 优化版到 data/web_images/                    │
│ 5. 生成 400px 缩略图到 data/thumbnails/                         │
│ 6. 解析 EXIF 元数据                                             │
│ 7. GPS 坐标逆地理编码                                           │
│ 8. 更新 library.json 索引                                       │
└─────────────────────────────────────────────────────────────────┘
```

**照片索引结构** (`library.json`):

```json
[
  {
    "id": "uuid-string",
    "filename": "uuid.jpg",
    "original_filename": "IMG_001.jpg",
    "size": 3145728,
    "hash": "sha256-hash-string",
    "created_at": "2025-01-01T12:00:00",
    "url": "/api/library/photos/uuid.jpg",
    "thumbnail_url": "/api/library/photos/uuid.jpg/thumbnail",
    "web_url": "/api/library/photos/uuid.jpg/web",
    "type": "image",
    "date_taken": "2024-12-25T10:30:00",
    "make": "Apple",
    "model": "iPhone 15 Pro",
    "location": {"lat": 39.9, "lon": 116.4},
    "location_name": "北京市东城区",
    "has_location": true
  }
]
```

**旋转设计**:

```python
def rotate_photo(self, photo_id: str, degree: int) -> bool:
    """旋转照片（只修改展示版，不修改原图）"""
    # 从原图重新生成旋转后的 web 版和缩略图
    with Image.open(original_path) as img:
        rotated = img.rotate(-degree, expand=True)
        
        # 生成 Web 优化图 (1280px)
        web_img = rotated.copy()
        web_img.thumbnail((1280, 1280), Image.Resampling.LANCZOS)
        web_img.save(web_path, "JPEG", quality=75)
        
        # 生成缩略图 (400px)
        rotated.thumbnail((400, 400))
        rotated.save(thumb_path, "JPEG", quality=80)
    
    # 记录累计旋转角度
    self.update_photo(photo_id, {"rotation": new_rotation})
```

---

### 相册服务 (AlbumService)

**文件**: `app/services/album_service.py`

**设计理念**: 相册是照片的**逻辑分组**，只存储照片 ID 引用，不复制文件。

**相册元数据结构** (`albums/{id}/metadata.json`):

```json
{
  "id": "uuid-string",
  "name": "家庭旅行",
  "description": "2024年春节旅行照片",
  "created_at": "2025-01-01T12:00:00",
  "updated_at": "2025-01-02T15:30:00",
  "photo_count": 50,
  "cover_photo": "uuid.jpg",
  "photo_ids": ["photo-id-1", "photo-id-2", "..."]
}
```

**关键方法**:

```python
class AlbumService:
    def add_photos(self, album_id: str, photo_ids: List[str]):
        """添加照片到相册（只添加引用）"""
        metadata = self._load_metadata(album_id)
        current_ids = set(metadata.get("photo_ids", []))
        for pid in photo_ids:
            current_ids.add(pid)
        metadata["photo_ids"] = list(current_ids)
        self._save_metadata(album_id, metadata)
    
    def get_all_active_photos(self) -> List[Dict]:
        """获取所有激活相册的照片（用于轮播）"""
        active_albums = self.config.get("albums.active_albums", []) or []
        all_photos = []
        seen_ids = set()  # 去重
        
        for album_id in active_albums:
            metadata = self._load_metadata(album_id)
            for pid in metadata.get("photo_ids", []):
                if pid not in seen_ids:
                    seen_ids.add(pid)
                    photo = self.library_service.get_photo(pid)
                    if photo:
                        all_photos.append(photo)
        
        # 根据配置排序
        if self.config.get("ui.slideshow_order") == "shuffle":
            random.shuffle(all_photos)
        else:
            all_photos.sort(key=lambda x: x.get("created_at", ""), reverse=True)
        
        return all_photos
```

**清理引用**:

```python
def purge_photo_from_all_albums(self, photo_id: str):
    """从所有相册中清除指定照片引用（删除照片时调用）"""
    for album_dir in self.albums_dir.iterdir():
        if album_dir.is_dir():
            self.remove_photos(album_dir.name, [photo_id])
```

---

### 金融服务 (FinanceService)

**文件**: `app/services/finance_service.py`

**数据模型**:

```python
class StockConfig(BaseModel):
    symbol: str           # 股票代码
    name: str             # 股票名称
    type: str = "watching"  # holding 或 watching
    target_buy_price: float = 0.0
    target_sell_price: float = 0.0
    cost_price: float = 0.0
    shares: int = 0

class IndexConfig(BaseModel):
    symbol: str
    name: str
```

**数据获取** (`app/api/finance.py`):

```python
@router.get("/stock/{symbol}")
async def get_stock(symbol: str, service: FinanceService = Depends(get_service)):
    """获取单个股票详情及历史趋势"""
    ticker = yf.Ticker(symbol)
    
    # 基础信息
    info = ticker.fast_info
    price = info.last_price
    prev_close = info.previous_close
    
    # 扩展信息
    year_high = info.year_high
    year_low = info.year_low
    volume = info.last_volume
    
    # 分析师目标价
    full_info = ticker.info
    analyst_target = full_info.get('targetMeanPrice')
    
    # 3年周线历史数据
    hist = ticker.history(period="3y", interval="1wk")
    hist['MA50'] = hist['Close'].rolling(window=50).mean()
    
    # 找到52周高低点日期
    recent_year = hist.tail(52)
    year_high_date = recent_year['High'].idxmax().strftime("%Y-%m-%d")
    year_low_date = recent_year['Low'].idxmin().strftime("%Y-%m-%d")
    
    return StockData(...)
```

---

### YouTube服务 (YouTubeService)

**文件**: `app/services/youtube.py`

**核心功能**:
- 从 URL 提取视频/频道 ID
- 标准化 URL 为 embed 格式
- 管理预设和自定义频道

```python
class YouTubeService:
    @staticmethod
    def extract_video_id(url: str) -> Optional[str]:
        """从 URL 提取视频 ID"""
        patterns = [
            r'(?:youtube\.com\/embed\/|youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})',
            r'youtube\.com\/channel\/([a-zA-Z0-9_-]+)',
        ]
        for pattern in patterns:
            match = re.search(pattern, url)
            if match:
                return match.group(1)
        return None
    
    @staticmethod
    def normalize_url(url: str) -> str:
        """标准化为 embed 格式"""
        video_id = YouTubeService.extract_video_id(url)
        if video_id:
            return f"https://www.youtube.com/embed/{video_id}?autoplay=1&mute=0"
        return url
```

---

## API 设计

### RESTful 风格

所有 API 遵循 RESTful 设计原则：

- `GET` - 获取资源
- `POST` - 创建资源
- `PUT` - 更新资源
- `DELETE` - 删除资源

### 认证 API

| 方法 | 路径 | 描述 | 需认证 |
|------|------|------|--------|
| POST | `/api/auth/login` | 用户登录 | ❌ |
| POST | `/api/auth/logout` | 用户登出 | ✅ |
| POST | `/api/auth/setup` | 初始设置密码 | ❌ |
| POST | `/api/auth/change-password` | 修改密码 | ✅ |

### 相册 API

| 方法 | 路径 | 描述 |
|------|------|------|
| GET | `/api/albums` | 获取所有相册 |
| POST | `/api/albums` | 创建相册 |
| GET | `/api/albums/{id}` | 获取相册详情 |
| PUT | `/api/albums/{id}` | 更新相册信息 |
| DELETE | `/api/albums/{id}` | 删除相册 |
| GET | `/api/albums/{id}/photos` | 获取相册照片 |
| POST | `/api/albums/{id}/photos` | 上传照片到相册 |
| POST | `/api/albums/{id}/photos/add` | 添加现有照片到相册 |
| POST | `/api/albums/{id}/photos/remove` | 从相册移除照片 |
| GET | `/api/albums/slideshow` | 获取轮播照片（无需认证） |

### 照片库 API

| 方法 | 路径 | 描述 |
|------|------|------|
| GET | `/api/library/photos` | 获取所有照片 |
| POST | `/api/library/photos` | 上传照片到库 |
| PUT | `/api/library/photos/{id}` | 更新照片信息 |
| POST | `/api/library/photos/{id}/rotate` | 旋转照片 |
| DELETE | `/api/library/photos/{id}` | 删除照片 |
| GET | `/api/library/photos/{filename}` | 获取原图 |
| GET | `/api/library/photos/{filename}/thumbnail` | 获取缩略图 |
| GET | `/api/library/photos/{filename}/web` | 获取 Web 优化图 |

### 金融 API

| 方法 | 路径 | 描述 |
|------|------|------|
| GET | `/api/finance/indices` | 获取指数实时数据 |
| GET | `/api/finance/indices/config` | 获取指数配置列表 |
| POST | `/api/finance/indices/config` | 添加指数配置 |
| DELETE | `/api/finance/indices/config/{symbol}` | 删除指数配置 |
| GET | `/api/finance/stock/{symbol}` | 获取个股详情 |
| GET | `/api/finance/config` | 获取股票配置列表 |
| POST | `/api/finance/config` | 添加股票配置 |
| PUT | `/api/finance/config/{symbol}` | 更新股票配置 |
| DELETE | `/api/finance/config/{symbol}` | 删除股票配置 |
| GET | `/api/finance/watchlist` | 获取自选股列表 |

### YouTube API

| 方法 | 路径 | 描述 |
|------|------|------|
| GET | `/api/youtube/channels` | 获取所有频道 |
| GET | `/api/youtube/embed/{channel}` | 获取频道 embed URL |
| POST | `/api/youtube/custom` | 添加自定义频道 |
| DELETE | `/api/youtube/custom/{name}` | 删除自定义频道 |

### 设置 API

| 方法 | 路径 | 描述 |
|------|------|------|
| GET | `/api/settings/` | 获取所有设置 |
| POST | `/api/settings/` | 更新设置 |

---

## 前端架构

### 模板渲染

使用 Jinja2 模板引擎，基于 `base.html` 模板继承：

```html
<!-- base.html -->
<!DOCTYPE html>
<html>
<head>
    <title>{% block title %}Lookoukwindow{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', path='style.css') }}">
    {% block extra_css %}{% endblock %}
</head>
<body>
    <main class="container">
        {% block content %}{% endblock %}
    </main>
    {% block extra_js %}{% endblock %}
</body>
</html>
```

### JavaScript 模块

首页 JavaScript 逻辑按功能划分：

| 模块 | 职责 |
|------|------|
| **时间日期** | 更新时间显示、农历转换 |
| **天气** | 调用 Open-Meteo API 更新天气 |
| **指数** | 更新指数滚动栏、渲染迷你图表 |
| **个股** | 轮播个股卡片、渲染趋势图 |
| **相册** | 加载轮播照片、切换动画、预加载 |
| **休眠** | 检测时间、进入/退出休眠模式 |

### 样式设计

CSS 设计特点：

1. **响应式布局**: 使用 Flexbox 实现左右分栏
2. **动画效果**: 照片切换使用 CSS 过渡动画
3. **颜色主题**: 深色背景，符合屏幕展示场景
4. **涨跌配色**: 遵循中国股市惯例（红涨绿跌）

```css
/* 涨跌颜色 */
.up { color: #e74c3c; }      /* 红色上涨 */
.down { color: #2ecc71; }    /* 绿色下跌 */

/* 渐变背景 */
.dashboard-bottom-finance {
    background: linear-gradient(to top, rgba(30,30,30,0.95), rgba(10,10,10,0.9));
}

/* 照片切换动画 */
.effect-fade.active {
    opacity: 1;
    transition: opacity 1s;
}
.effect-slide-left.active {
    transform: translateX(0);
    transition: transform 1s ease-in-out;
}
```

---

## 数据存储设计

### 配置文件

**文件**: `data/config.yaml`

**结构**:

```yaml
youtube:
  presets:
    - name: "NASA TV"
      url: "https://www.youtube.com/embed/xxx"
      channel_id: "xxx"
  custom_channels: []
  default_channel: "NASA TV"

albums:
  active_albums: []  # 激活的相册 ID 列表

ui:
  layout: "side-by-side"
  slideshow_interval_seconds: 10
  slideshow_transition: "fade"
  show_metadata: true
  time_format: "24h"

weather:
  location_name: "北京市大兴区"
  latitude: 39.73
  longitude: 116.33

energy:
  enabled: true
  start_time: "22:30"
  end_time: "05:30"

finance:
  indices: [...]
  stocks: [...]
  update_interval_seconds: 60
  ticker_speed_seconds: 30
  stock_switch_interval_seconds: 10

security:
  login_password_hash: "bcrypt-hash"
  session_secret: "random-string"
```

### 照片存储

**三层存储策略**:

| 目录 | 内容 | 尺寸 | 用途 |
|------|------|------|------|
| `data/library/` | 原始照片 | 原始尺寸 | 永久保存，不做任何处理 |
| `data/web_images/` | 压缩版 | ≤1280px | 前端轮播展示 |
| `data/thumbnails/` | 缩略图 | ≤400px | 管理页面预览 |

### 索引文件

| 文件 | 内容 |
|------|------|
| `data/library/library.json` | 照片库索引（所有照片元数据） |
| `data/albums/{id}/metadata.json` | 相册元数据 |
| `data/stocks.json` | 股票配置 |
| `data/indices.json` | 指数配置 |

---

## 安全设计

### 密码安全

```python
# 使用 bcrypt 哈希
pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")
password_hash = pwd_context.hash(plain_password)

# 验证密码
result = pwd_context.verify(plain_password, password_hash)
```

### JWT 令牌

```python
# 生成令牌
token = jwt.encode(
    {"sub": "user", "exp": expire_time},
    secret_key,
    algorithm="HS256"
)

# 验证令牌
payload = jwt.decode(token, secret_key, algorithms=["HS256"])
```

### 认证中间件

```python
@app.middleware("http")
async def auth_middleware(request: Request, call_next):
    # 排除公开路由
    if request.url.path in ["/", "/login", "/setup", "/favicon.ico"]:
        return await call_next(request)
    
    if request.url.path.startswith("/api/") or request.url.path.startswith("/static/"):
        return await call_next(request)
    
    # 验证认证状态
    auth_manager = AuthManager(config)
    is_authenticated = await auth_manager.get_current_user(request)
    
    if not is_authenticated:
        return RedirectResponse(url="/login")
    
    return await call_next(request)
```

### HTTP 响应头

```python
@app.middleware("http")
async def add_referrer_policy(request: Request, call_next):
    response = await call_next(request)
    if "text/html" in response.headers.get("content-type", ""):
        # 修复 YouTube 错误 153
        response.headers["Referrer-Policy"] = "origin"
        # 允许 YouTube iframe 权限
        response.headers["Permissions-Policy"] = (
            "accelerometer=*, autoplay=*, clipboard-write=*, "
            "encrypted-media=*, fullscreen=*, gyroscope=*, "
            "picture-in-picture=*, web-share=*"
        )
    return response
```

---

## 部署架构

### 开发环境

```bash
# 创建虚拟环境
python3 -m venv venv
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt

# 启动服务
python run.py
```

### 生产环境 (systemd)

**服务文件**: `lookoukwindow.service`

```ini
[Unit]
Description=Lookoukwindow Application
After=network.target

[Service]
Type=simple
User=pi
WorkingDirectory=/home/pi/Lookoukwindow
ExecStart=/home/pi/Lookoukwindow/venv/bin/python run.py
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
```

**启用服务**:

```bash
sudo cp lookoukwindow.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable lookoukwindow
sudo systemctl start lookoukwindow
```

### Kiosk 模式

**脚本**: `scripts/kiosk.sh`

**功能**:
1. 等待桌面环境启动
2. 禁用屏幕保护和电源管理
3. 等待 Web 服务就绪
4. 启动浏览器全屏模式

---

## 性能优化

### 图片优化

| 优化项 | 实现方式 |
|--------|----------|
| 压缩存储 | Web 优化版 1280px，质量 75% |
| 缩略图 | 400px 小图用于列表 |
| 懒加载 | 前端使用 `loading="eager"` 预加载 |
| 缓存破坏 | URL 添加时间戳参数 |

### 数据缓存

```python
class LibraryService:
    def __init__(self, config: Config):
        # 内存缓存索引
        self._library_index = self._load_index()
```

### 前端预加载

```javascript
function preloadNextPhoto(currentIndex) {
    const nextIndex = (currentIndex + 1) % photos.length;
    const nextPhoto = photos[nextIndex];
    const img = new Image();
    img.src = nextPhoto.web_url || nextPhoto.url;
}
```

### 日志轮转

```python
file_handler = logging.handlers.TimedRotatingFileHandler(
    filename=str(log_file),
    when="midnight",
    interval=1,
    backupCount=30,
    encoding="utf-8"
)
```

---

## 扩展指南

### 添加新的 API 路由

1. 在 `app/api/` 下创建新模块：

```python
# app/api/new_feature.py
from fastapi import APIRouter

router = APIRouter(prefix="/api/new-feature", tags=["new-feature"])

@router.get("/")
async def get_feature():
    return {"status": "ok"}
```

2. 在 `app/main.py` 中注册路由：

```python
from .api import new_feature
app.include_router(new_feature.router)
```

### 添加新的服务

1. 在 `app/services/` 下创建服务类：

```python
# app/services/new_service.py
class NewService:
    def __init__(self, config: Config):
        self.config = config
    
    def do_something(self):
        pass
```

2. 在 API 层通过依赖注入使用：

```python
def get_new_service(config: Config = Depends(get_config)):
    return NewService(config)

@router.get("/")
async def endpoint(service: NewService = Depends(get_new_service)):
    return service.do_something()
```

### 添加新的配置项

1. 在 `Config._create_default_config()` 中添加默认值
2. 使用 `config.get("path.to.key")` 访问
3. 使用 `config.set("path.to.key", value)` 设置
4. 调用 `config.save()` 保存

---

## 许可证

本项目采用 GPL-3.0 许可证开源。详见 [LICENSE](../LICENSE) 文件。

